name: üß™ Test ServiceNow DevOps Change Action

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod

jobs:
  test-change-request:
    name: Test ServiceNow DevOps Change Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: üìù Display Test Information
        run: |
          echo "=========================================="
          echo "ServiceNow DevOps Change Action Test"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo ""
          echo "This test will:"
          echo "1. Use official ServiceNow/servicenow-devops-change action"
          echo "2. Authenticate with Basic Auth (username/password)"
          echo "3. Use existing SN_ORCHESTRATION_TOOL_ID"
          echo "4. Create a test change request"
          echo ""

      - name: üîê Verify ServiceNow Credentials
        run: |
          if [ -z "${{ secrets.SERVICENOW_USERNAME }}" ]; then
            echo "‚ùå SERVICENOW_USERNAME secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.SERVICENOW_PASSWORD }}" ]; then
            echo "‚ùå SERVICENOW_PASSWORD secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.SERVICENOW_INSTANCE_URL }}" ]; then
            echo "‚ùå SERVICENOW_INSTANCE_URL secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.SN_ORCHESTRATION_TOOL_ID }}" ]; then
            echo "‚ö†Ô∏è  SN_ORCHESTRATION_TOOL_ID secret is not set"
            echo "    This is required for ServiceNow DevOps integration"
            echo "    The change request will be created but won't link to DORA metrics"
          fi

          echo "‚úÖ All required credentials are configured"

      - name: üéØ Create Change Request with Official Action (Basic Auth)
        id: create-change
        uses: ServiceNow/servicenow-devops-change@v4.0.0
        with:
          # Basic Authentication (username/password)
          devops-integration-user-name: ${{ secrets.SERVICENOW_USERNAME }}
          devops-integration-user-password: ${{ secrets.SERVICENOW_PASSWORD }}

          # ServiceNow instance
          instance-url: ${{ secrets.SERVICENOW_INSTANCE_URL }}

          # Tool ID for DORA metrics integration
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}

          # GitHub context (required for work items, commits, etc.)
          context-github: ${{ toJSON(github) }}

          # Job name (used for tracking)
          job-name: 'Test ServiceNow DevOps Change Action'

          # Change request details
          change-request: |
            {
              "short_description": "TEST: ServiceNow DevOps Change Action - ${{ inputs.environment }}",
              "description": "This is a TEST change request created by the ServiceNow DevOps Change GitHub Action.\n\nPurpose: Verify Basic Auth works with official action.\n\nWorkflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nEnvironment: ${{ inputs.environment }}\nTriggered by: ${{ github.actor }}",
              "assignment_group": "DevOps Team",
              "implementation_plan": "1. Verify official ServiceNow action works with Basic Auth\n2. Confirm change request is created\n3. Verify tool-id links to DORA metrics\n4. Check sn_devops tables for integration",
              "backout_plan": "This is a test - no actual deployment. Safe to close.",
              "test_plan": "1. Check change request created in ServiceNow\n2. Verify all custom fields populated\n3. Confirm GitHub context is captured\n4. Validate orchestration tool linkage",
              "risk_impact_analysis": "Risk: Low - Test only, no infrastructure changes\nImpact: None - Verification of integration"
            }
        continue-on-error: true

      - name: üìä Display Change Request Details
        if: always()
        run: |
          echo "=========================================="
          echo "Change Request Creation Result"
          echo "=========================================="
          echo ""

          if [ "${{ steps.create-change.outcome }}" = "success" ]; then
            echo "‚úÖ Change request created successfully!"
            echo ""
            echo "Change Request Details:"
            echo "  Number: ${{ steps.create-change.outputs.change-request-number }}"
            echo "  Sys ID: ${{ steps.create-change.outputs.change-request-sys-id }}"
            echo ""
            echo "View in ServiceNow:"
            echo "  ${{ secrets.SERVICENOW_INSTANCE_URL }}/nav_to.do?uri=change_request.do?sys_id=${{ steps.create-change.outputs.change-request-sys-id }}"
          else
            echo "‚ùå Change request creation failed"
            echo ""
            echo "This could be due to:"
            echo "  - Basic Auth not supported by this action version"
            echo "  - Missing SN_ORCHESTRATION_TOOL_ID"
            echo "  - ServiceNow instance configuration"
            echo "  - Network/connectivity issues"
          fi

      - name: üîç Verify Change Request via REST API
        if: steps.create-change.outcome == 'success'
        run: |
          echo "=========================================="
          echo "Verifying Change Request via REST API"
          echo "=========================================="
          echo ""

          CR_SYS_ID="${{ steps.create-change.outputs.change-request-sys-id }}"

          # Fetch change request details
          RESPONSE=$(curl -s -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -H "Accept: application/json" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/change_request/$CR_SYS_ID?sysparm_display_value=true")

          echo "Change Request Data:"
          echo "$RESPONSE" | jq -r '.result | {
            number: .number,
            short_description: .short_description,
            state: .state,
            assignment_group: .assignment_group.display_value,
            requested_by: .requested_by.display_value,
            sys_created_on: .sys_created_on
          }'

          echo ""
          echo "‚úÖ Change request verified in ServiceNow"

      - name: üîó Check Integration with sn_devops Tables
        if: steps.create-change.outcome == 'success'
        run: |
          echo "=========================================="
          echo "Checking ServiceNow DevOps Integration"
          echo "=========================================="
          echo ""

          CR_NUMBER="${{ steps.create-change.outputs.change-request-number }}"

          # Check if tool-id integration exists
          echo "Checking orchestration tool integration..."
          TOOL_RESPONSE=$(curl -s -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -H "Accept: application/json" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/sn_devops_orchestration_tool?sysparm_query=sys_id=${{ secrets.SN_ORCHESTRATION_TOOL_ID }}")

          TOOL_EXISTS=$(echo "$TOOL_RESPONSE" | jq -r '.result | length')

          if [ "$TOOL_EXISTS" -gt 0 ]; then
            echo "‚úÖ Orchestration tool registration found"
            echo "$TOOL_RESPONSE" | jq -r '.result[0] | {
              name: .name,
              type: .type,
              url: .url
            }'
          else
            echo "‚ö†Ô∏è  Orchestration tool not found"
            echo "   Tool ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}"
            echo "   This means DORA metrics won't be tracked"
          fi

          echo ""
          echo "Checking for linked DevOps records..."

          # Check test results
          TEST_RESULTS=$(curl -s -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -H "Accept: application/json" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/sn_devops_test_result?sysparm_query=change_request.number=$CR_NUMBER&sysparm_limit=5")

          TEST_COUNT=$(echo "$TEST_RESULTS" | jq -r '.result | length')
          echo "  Test Results: $TEST_COUNT records"

          # Check artifacts
          ARTIFACTS=$(curl -s -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -H "Accept: application/json" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/sn_devops_artifact?sysparm_query=change_request.number=$CR_NUMBER&sysparm_limit=5")

          ARTIFACT_COUNT=$(echo "$ARTIFACTS" | jq -r '.result | length')
          echo "  Artifacts: $ARTIFACT_COUNT records"

          # Check work items
          WORK_ITEMS=$(curl -s -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -H "Accept: application/json" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/sn_devops_work_item?sysparm_query=change_request.number=$CR_NUMBER&sysparm_limit=5")

          WORK_ITEM_COUNT=$(echo "$WORK_ITEMS" | jq -r '.result | length')
          echo "  Work Items: $WORK_ITEM_COUNT records"

      - name: üìà Test Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Test Summary"
          echo "=========================================="
          echo ""

          if [ "${{ steps.create-change.outcome }}" = "success" ]; then
            echo "‚úÖ SUCCESS: Official ServiceNow DevOps Change action works with Basic Auth!"
            echo ""
            echo "Next Steps:"
            echo "1. Review change request in ServiceNow"
            echo "2. Check if DORA metrics are being captured"
            echo "3. Verify integration with sn_devops tables"
            echo "4. Consider migrating other workflows to use this action"
            echo ""
            echo "Benefits of Official Action:"
            echo "  ‚úÖ Native integration with Change Velocity"
            echo "  ‚úÖ Automatic DORA metrics tracking"
            echo "  ‚úÖ Built-in error handling and retries"
            echo "  ‚úÖ Maintained by ServiceNow (security updates)"
            echo "  ‚úÖ Supports both Basic Auth and Token auth"
          else
            echo "‚ùå FAILED: Official action did not work as expected"
            echo ""
            echo "Possible Issues:"
            echo "1. Action version may not support Basic Auth"
            echo "2. SN_ORCHESTRATION_TOOL_ID may be invalid"
            echo "3. ServiceNow DevOps plugin not activated"
            echo "4. Network/firewall blocking GitHub ‚Üí ServiceNow"
            echo ""
            echo "Fallback: Continue using custom REST API approach"
          fi

          echo ""
          echo "Documentation:"
          echo "  - ServiceNow DevOps Change Action: https://github.com/ServiceNow/servicenow-devops-change"
          echo "  - Our Analysis: docs/SERVICENOW-DEVOPS-CHANGE-VELOCITY-ANALYSIS.md"

      - name: üßπ Cleanup (Optional)
        if: steps.create-change.outcome == 'success' && inputs.environment == 'dev'
        run: |
          echo "=========================================="
          echo "Cleanup Test Change Request"
          echo "=========================================="
          echo ""
          echo "For dev environment, we can optionally close the test CR"
          echo ""
          echo "To close manually:"
          echo "1. Go to: ${{ secrets.SERVICENOW_INSTANCE_URL }}/nav_to.do?uri=change_request.do?sys_id=${{ steps.create-change.outputs.change-request-sys-id }}"
          echo "2. Click 'Close'"
          echo "3. Add close notes: 'Test completed successfully'"
          echo ""
          echo "Or via API:"
          echo "curl -u \"\$SERVICENOW_USERNAME:\$SERVICENOW_PASSWORD\" \\"
          echo "  -H 'Content-Type: application/json' \\"
          echo "  -X PATCH \\"
          echo "  -d '{\"state\":\"3\",\"close_code\":\"successful\",\"close_notes\":\"Test completed\"}' \\"
          echo "  \"${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/change_request/${{ steps.create-change.outputs.change-request-sys-id }}\""
