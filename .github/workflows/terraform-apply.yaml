---
name: "Terraform Apply (Reusable)"

"on":
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy (dev/qa/prod)'
        required: true
        type: string
      action:
        description: 'Terraform action (apply/destroy)'
        required: false
        type: string
        default: 'apply'
      tf_version:
        description: 'Terraform version'
        required: false
        type: string
        default: '1.5.0'
    outputs:
      cluster_name:
        description: "EKS cluster name"
        value: ${{ jobs.terraform-apply.outputs.cluster_name }}
      cluster_endpoint:
        description: "EKS cluster endpoint"
        value: ${{ jobs.terraform-apply.outputs.cluster_endpoint }}
      region:
        description: "AWS region"
        value: ${{ jobs.terraform-apply.outputs.region }}
      apply_outcome:
        description: "Outcome of terraform apply"
        value: ${{ jobs.terraform-apply.outputs.apply_outcome }}

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: eu-west-2

jobs:
  # Create ServiceNow Change Request before infrastructure changes
  servicenow-change:
    name: ServiceNow Change Request
    uses: ./.github/workflows/servicenow-change-rest.yaml
    with:
      environment: ${{ inputs.environment }}
      change_type: 'terraform'
      short_description: 'Terraform ${{ inputs.action }} - ${{ inputs.environment }} infrastructure'
      description: |
        Infrastructure change via Terraform ${{ inputs.action }} command.

        Environment: ${{ inputs.environment }}
        Action: ${{ inputs.action }}
        Terraform Version: ${{ inputs.tf_version }}
        Triggered by: ${{ github.actor }}
        Commit: ${{ github.sha }}
        Workflow: ${{ github.workflow }}
      implementation_plan: |
        1. Initialize Terraform with remote backend
        2. Validate configuration syntax
        3. Generate and review execution plan
        4. ${{ inputs.action == 'apply' && 'Apply infrastructure changes' || 'Destroy infrastructure resources' }}
        5. Verify EKS cluster accessibility
        6. Update kubeconfig for kubectl access
      backout_plan: |
        1. Review terraform state backup
        2. Execute terraform apply with previous configuration
        3. Verify infrastructure rolled back successfully
        4. Validate all services operational
      test_plan: |
        1. Verify terraform validation passed
        2. Review terraform plan for expected changes
        3. Confirm EKS cluster accessible via kubectl
        4. Verify node groups healthy
        5. Check all AWS resources created/updated correctly
    secrets: inherit

  terraform-apply:
    name: Terraform ${{ inputs.action }} (${{ inputs.environment }})
    needs: servicenow-change
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      cluster_name: ${{ steps.eks-info.outputs.cluster_name }}
      cluster_endpoint: ${{ steps.eks-info.outputs.cluster_endpoint }}
      region: ${{ steps.eks-info.outputs.region }}
      apply_outcome: ${{ steps.apply.outcome || steps.destroy.outcome }}
      change_request: ${{ needs.servicenow-change.outputs.change_request_number }}

    defaults:
      run:
        working-directory: terraform-aws

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup AWS Credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          aws-region: ${{ env.AWS_REGION }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform-version: ${{ inputs.tf_version }}
          terraform-wrapper: 'false'  # Disable wrapper to get clean outputs

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          if [ -f "environments/${{ inputs.environment }}.tfvars" ]; then
            terraform plan -out=tfplan -input=false -var-file=environments/${{ inputs.environment }}.tfvars
          else
            terraform plan -out=tfplan -input=false
          fi

      - name: Terraform Apply
        if: inputs.action == 'apply'
        id: apply
        run: terraform apply -auto-approve -input=false tfplan

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        id: destroy
        run: |
          if [ -f "environments/${{ inputs.environment }}.tfvars" ]; then
            terraform destroy -auto-approve -input=false -var-file=environments/${{ inputs.environment }}.tfvars
          else
            terraform destroy -auto-approve -input=false
          fi

      - name: Get EKS Cluster Info
        if: steps.apply.outcome == 'success'
        id: eks-info
        run: |
          echo "cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo 'microservices')" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$(terraform output -raw cluster_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "region=$(terraform output -raw region 2>/dev/null || echo 'eu-west-2')" >> $GITHUB_OUTPUT

      - name: Update kubeconfig
        if: steps.apply.outcome == 'success'
        run: |
          aws eks update-kubeconfig \
            --region ${{ steps.eks-info.outputs.region }} \
            --name ${{ steps.eks-info.outputs.cluster_name }}

      - name: Verify EKS Access
        if: steps.apply.outcome == 'success'
        run: |
          kubectl get nodes
          kubectl get namespaces

      - name: Create Summary
        if: always()
        run: |
          echo "## Terraform Deployment Summary (${{ inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ServiceNow Change Request
          if [ -n "${{ needs.servicenow-change.outputs.change_request_number }}" ]; then
            echo "### 📋 ServiceNow Change Request" >> $GITHUB_STEP_SUMMARY
            echo "- **Change Number**: [\`${{ needs.servicenow-change.outputs.change_request_number }}\`](${{ secrets.SERVICENOW_INSTANCE_URL }}/nav_to.do?uri=change_request.do?sysparm_query=number=${{ needs.servicenow-change.outputs.change_request_number }})" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.environment }}" == "dev" ]; then
              echo "- **Approval**: ✅ Auto-Approved (DEV)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Approval**: ✅ Approved via ServiceNow" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | ${{ steps.plan.outcome }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.action }}" == "apply" ]; then
            echo "| Apply | ${{ steps.apply.outcome }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Destroy | ${{ steps.destroy.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "### 🎉 Infrastructure Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Cluster Information**:" >> $GITHUB_STEP_SUMMARY
            echo "- **Name**: \`${{ steps.eks-info.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Region**: \`${{ steps.eks-info.outputs.region }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Endpoint**: \`${{ steps.eks-info.outputs.cluster_endpoint }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Configure kubectl" >> $GITHUB_STEP_SUMMARY
            echo "aws eks update-kubeconfig --region ${{ steps.eks-info.outputs.region }} --name ${{ steps.eks-info.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Deploy application" >> $GITHUB_STEP_SUMMARY
            echo "kubectl apply -k kustomize/overlays/${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.destroy.outcome }}" == "success" ]; then
            echo "### ⚠️ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources for **${{ inputs.environment }}** have been removed." >> $GITHUB_STEP_SUMMARY
          fi
