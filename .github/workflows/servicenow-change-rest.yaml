---
name: "ServiceNow Change Request (REST API)"

# IMPORTANT: This workflow uses ServiceNow Table API (/api/now/table/change_request)
# instead of DevOps Change Control API (/api/sn_devops/v1/devops/orchestration/changeControl)
# Reason: Table API supports custom fields (u_*) for comprehensive audit trail and compliance.
# DevOps API does not support custom fields, which are critical for SOC 2/ISO 27001 compliance.
# See docs/SERVICENOW-API-COMPARISON.md for detailed comparison.

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (dev/qa/prod)"
        required: true
        type: string
      change_type:
        description: "Type of change (kubernetes/terraform/configuration)"
        required: false
        type: string
        default: "kubernetes"
      short_description:
        description: "Short description of the change"
        required: true
        type: string
      description:
        description: "Detailed description of the change"
        required: false
        type: string
      implementation_plan:
        description: "Implementation plan"
        required: false
        type: string
      backout_plan:
        description: "Backout plan"
        required: false
        type: string
      test_plan:
        description: "Test plan"
        required: false
        type: string
      assignment_group:
        description: "Assignment group for the change"
        required: false
        type: string
        default: "GitHubARC DevOps Admin"
      assigned_to:
        description: "User assigned to the change"
        required: false
        type: string
        default: "Olaf Krasicki-Freund"
      # Additional deployment context
      services_deployed:
        description: "JSON array of services being deployed"
        required: false
        type: string
        default: "[]"
      infrastructure_changes:
        description: "Whether infrastructure changes are included"
        required: false
        type: string
        default: "false"
      security_scanners:
        description: "List of security scanners that ran"
        required: false
        type: string
        default: ""
      pr_number:
        description: "Pull request number if triggered by PR"
        required: false
        type: string
        default: ""
      previous_version:
        description: "Previous version being replaced"
        required: false
        type: string
        default: ""
      # Security scan results
      security_scan_status:
        description: "Overall security scan status (passed/failed/warning)"
        required: false
        type: string
        default: ""
      critical_vulnerabilities:
        description: "Count of critical severity vulnerabilities"
        required: false
        type: string
        default: "0"
      high_vulnerabilities:
        description: "Count of high severity vulnerabilities"
        required: false
        type: string
        default: "0"
      medium_vulnerabilities:
        description: "Count of medium severity vulnerabilities"
        required: false
        type: string
        default: "0"
      # Deployment metadata
      deployment_method:
        description: "Deployment method (e.g., Kustomize overlays, Helm, kubectl)"
        required: false
        type: string
        default: "Kustomize overlays"
      application_url:
        description: "Load balancer URL for the deployed application"
        required: false
        type: string
        default: ""
      # Unit test results
      unit_test_status:
        description: "Unit test status (passed/failed)"
        required: false
        type: string
        default: ""
      unit_test_total:
        description: "Total number of unit tests"
        required: false
        type: string
        default: "0"
      unit_test_passed:
        description: "Number of unit tests passed"
        required: false
        type: string
        default: "0"
      unit_test_failed:
        description: "Number of unit tests failed"
        required: false
        type: string
        default: "0"
      unit_test_coverage:
        description: "Unit test code coverage percentage"
        required: false
        type: string
        default: ""
      unit_test_url:
        description: "URL to view unit test results"
        required: false
        type: string
        default: ""
      # SonarCloud results
      sonarcloud_status:
        description: "SonarCloud quality gate status (passed/failed/warning)"
        required: false
        type: string
        default: ""
      sonarcloud_bugs:
        description: "Number of bugs detected by SonarCloud"
        required: false
        type: string
        default: "0"
      sonarcloud_vulnerabilities:
        description: "Number of vulnerabilities detected by SonarCloud"
        required: false
        type: string
        default: "0"
      sonarcloud_code_smells:
        description: "Number of code smells detected by SonarCloud"
        required: false
        type: string
        default: "0"
      sonarcloud_coverage:
        description: "SonarCloud code coverage percentage"
        required: false
        type: string
        default: ""
      sonarcloud_duplications:
        description: "SonarCloud code duplication percentage"
        required: false
        type: string
        default: ""
      sonarcloud_url:
        description: "URL to view SonarCloud dashboard"
        required: false
        type: string
        default: ""
      # Smoke test / Performance test results
      smoke_test_status:
        description: "Smoke test status (passed/failed)"
        required: false
        type: string
        default: ""
      smoke_test_duration:
        description: "Smoke test duration in seconds"
        required: false
        type: string
        default: ""
      smoke_test_url:
        description: "URL to view smoke test results"
        required: false
        type: string
        default: ""
    outputs:
      change_number:
        description: "ServiceNow Change Request Number"
        value: ${{ jobs.create-change.outputs.change_number }}
      change_sys_id:
        description: "ServiceNow Change Request Sys ID"
        value: ${{ jobs.create-change.outputs.change_sys_id }}

permissions:
  contents: read

jobs:
  create-change:
    name: "Create Change Request (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    outputs:
      change_number: ${{ steps.create-cr.outputs.change_number }}
      change_sys_id: ${{ steps.create-cr.outputs.change_sys_id }}

    steps:
      - name: Prepare Change Request Data
        id: prepare
        run: |
          # Determine state based on environment
          # ServiceNow accepts text state values: new, assess, authorize, scheduled, implement, review, closed
          # Dev: Auto-approved and ready to deploy
          # QA/Prod: Requires manual approval
          if [ "${{ inputs.environment }}" = "dev" ]; then
            STATE="scheduled"  # Auto-approved, ready to deploy (converts to state -2)
            PRIORITY="3"       # Low priority
          elif [ "${{ inputs.environment }}" = "qa" ]; then
            STATE="assess"     # Requires manual approval (converts to state -4)
            PRIORITY="3"       # Medium priority
          else
            STATE="assess"     # Requires manual approval (converts to state -4)
            PRIORITY="2"       # High priority (production)
          fi

          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT

      - name: Validate ServiceNow Configuration
        id: validate-config
        env:
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          SN_ORCHESTRATION_TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
        run: |
          echo "üîç Validating ServiceNow configuration..."
          echo ""

          ERRORS=0

          # Validate SN_ORCHESTRATION_TOOL_ID
          if [ -z "$SN_ORCHESTRATION_TOOL_ID" ]; then
            echo "‚ùå SN_ORCHESTRATION_TOOL_ID not set"
            ERRORS=$((ERRORS + 1))
          elif [ "$SN_ORCHESTRATION_TOOL_ID" = "null" ]; then
            echo "‚ùå SN_ORCHESTRATION_TOOL_ID is literal 'null'"
            ERRORS=$((ERRORS + 1))
          elif [ ${#SN_ORCHESTRATION_TOOL_ID} -ne 32 ]; then
            echo "‚ùå SN_ORCHESTRATION_TOOL_ID wrong length (expected 32, got ${#SN_ORCHESTRATION_TOOL_ID})"
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ SN_ORCHESTRATION_TOOL_ID configured (${#SN_ORCHESTRATION_TOOL_ID} chars)"
            echo "   Value (first 10 chars): ${SN_ORCHESTRATION_TOOL_ID:0:10}..."
          fi

          # Validate SERVICENOW_INSTANCE_URL
          if [ -z "$SERVICENOW_INSTANCE_URL" ]; then
            echo "‚ùå SERVICENOW_INSTANCE_URL not set"
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ SERVICENOW_INSTANCE_URL configured"
          fi

          # Validate SERVICENOW_USERNAME
          if [ -z "$SERVICENOW_USERNAME" ]; then
            echo "‚ùå SERVICENOW_USERNAME not set"
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ SERVICENOW_USERNAME configured"
          fi

          # Validate SERVICENOW_PASSWORD
          if [ -z "$SERVICENOW_PASSWORD" ]; then
            echo "‚ùå SERVICENOW_PASSWORD not set"
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ SERVICENOW_PASSWORD configured"
          fi

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå $ERRORS configuration error(s) found"
            echo ""
            echo "Please check GitHub Actions secrets:"
            echo "  - SERVICENOW_USERNAME"
            echo "  - SERVICENOW_PASSWORD"
            echo "  - SERVICENOW_INSTANCE_URL"
            echo "  - SN_ORCHESTRATION_TOOL_ID (should be: f62c4e49c3fcf614e1bbf0cb050131ef)"
            exit 1
          else
            echo "‚úÖ All ServiceNow secrets configured correctly"
          fi

      - name: Get or Create Application CI
        id: get-app-ci
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
        run: |
          echo "üì± Using ServiceNow Application..."

          # Use the existing "Online Boutique" application
          # We have TWO sys_ids for different purposes:
          #
          # 1. DevOps App (sn_devops_app table):
          #    - Sys ID: e489efd1c3383e14e1bbf0cb050131d5
          #    - Used for: packages, pipeline executions, test results
          #    - URL: https://calitiiltddemo3.service-now.com/now/devops-change/record/sn_devops_app/e489efd1c3383e14e1bbf0cb050131d5
          #
          # 2. CMDB CI Application (cmdb_ci_appl table):
          #    - Sys ID: bcb82fddc3057250e1bbf0cb05013118
          #    - Used for: change request cmdb_ci field (for "App" column visibility)
          #    - URL: https://calitiiltddemo3.service-now.com/now/nav/ui/classic/params/target/cmdb_ci_appl.do?sys_id=bcb82fddc3057250e1bbf0cb05013118
          #    - Owner: Olaf Krasicki-Freund
          #    - Approval Group: GitHubARC DevOps Admin
          #    - Location: United Kingdom
          #
          # Environment is tracked via u_environment field in change request

          APP_NAME="Online Boutique"
          DEVOPS_APP_SYS_ID="e489efd1c3383e14e1bbf0cb050131d5"  # For packages/pipelines/tests
          CMDB_CI_SYS_ID="bcb82fddc3057250e1bbf0cb05013118"      # For change request cmdb_ci (existing manual record)

          echo "  ‚úÖ Application: $APP_NAME"
          echo "     DevOps App sys_id: $DEVOPS_APP_SYS_ID (for packages/pipelines/tests)"
          echo "     CMDB CI sys_id: $CMDB_CI_SYS_ID (for change request App column)"
          echo "     Environment: $ENVIRONMENT (tracked in u_environment field)"

          # Validate we have valid sys_ids
          if [ -z "$DEVOPS_APP_SYS_ID" ] || [ "$DEVOPS_APP_SYS_ID" = "null" ]; then
            echo "‚ùå Failed to get DevOps App sys_id"
            exit 1
          fi
          if [ -z "$CMDB_CI_SYS_ID" ] || [ "$CMDB_CI_SYS_ID" = "null" ]; then
            echo "‚ùå Failed to get CMDB CI sys_id"
            exit 1
          fi

          # Export for next steps
          echo "app_sys_id=$DEVOPS_APP_SYS_ID" >> $GITHUB_OUTPUT
          echo "cmdb_ci_sys_id=$CMDB_CI_SYS_ID" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

          echo ""
          echo "‚úÖ Application ready for ServiceNow integration"

      - name: Create Change Request via REST API
        id: create-cr
        env:
          SHORT_DESC: ${{ inputs.short_description }} [${{ inputs.environment }}]
          DESCRIPTION: ${{ inputs.description || format('Automated deployment to {0} environment via GitHub Actions', inputs.environment) }}
          STATE: ${{ steps.prepare.outputs.state }}
          PRIORITY: ${{ steps.prepare.outputs.priority }}
          ASSIGNMENT_GROUP: ${{ inputs.assignment_group }}
          ASSIGNED_TO: ${{ inputs.assigned_to }}
          ENVIRONMENT: ${{ inputs.environment }}
          CHANGE_TYPE: ${{ inputs.change_type }}
          COMMIT_MESSAGE: ${{ toJSON(github.event.head_commit.message) }}
          IMPL_PLAN_INPUT: ${{ inputs.implementation_plan }}
          BACKOUT_PLAN_INPUT: ${{ inputs.backout_plan }}
          TEST_PLAN_INPUT: ${{ inputs.test_plan }}
          # ServiceNow API credentials
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
        run: |
          # Set default plans with proper newline formatting
          if [ -z "$IMPL_PLAN_INPUT" ]; then
            IMPL_PLAN=$(cat <<'EOF'
          1. Configure kubectl access to EKS cluster
          2. Apply Kustomize overlays
          3. Monitor rollout status
          4. Verify all pods healthy
          5. Test application endpoints
          EOF
          )
          else
            IMPL_PLAN="$IMPL_PLAN_INPUT"
          fi

          if [ -z "$BACKOUT_PLAN_INPUT" ]; then
            BACKOUT_PLAN=$(cat <<'EOF'
          1. Execute kubectl rollout undo
          2. Verify rollback completed
          3. Monitor pod status
          4. Test application functionality
          5. Notify stakeholders
          EOF
          )
          else
            BACKOUT_PLAN="$BACKOUT_PLAN_INPUT"
          fi

          if [ -z "$TEST_PLAN_INPUT" ]; then
            TEST_PLAN=$(cat <<'EOF'
          1. Verify deployments rolled out
          2. Check all pods Running
          3. Verify service endpoints
          4. Test frontend accessibility
          5. Monitor application metrics
          EOF
          )
          else
            TEST_PLAN="$TEST_PLAN_INPUT"
          fi

          # Determine risk/impact based on environment
          if [ "$ENVIRONMENT" = "prod" ]; then
            RISK="2"
            IMPACT="2"
            CAB_REQUIRED="true"
            PROD_SYSTEM="true"
          else
            RISK="3"
            IMPACT="3"
            CAB_REQUIRED="false"
            PROD_SYSTEM="false"
          fi

          # Extract branch name from ref
          BRANCH_NAME="${{ github.ref }}"
          BRANCH_NAME="${BRANCH_NAME#refs/heads/}"
          BRANCH_NAME="${BRANCH_NAME#refs/tags/}"

          # Determine PR number
          PR_NUM="${{ inputs.pr_number }}"

          # Try to get PR number from pull_request event
          if [ -z "$PR_NUM" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
          fi

          # Try to extract PR number from merge commit message (e.g., "Merge pull request #123")
          if [ -z "$PR_NUM" ]; then
            # Extract from first line only to avoid parsing entire commit body
            # COMMIT_MESSAGE is JSON-escaped, so parse it with jq first to get the raw string
            COMMIT_RAW=$(echo "$COMMIT_MESSAGE" | jq -r '.')
            COMMIT_FIRST_LINE="$(printf '%s\n' "$COMMIT_RAW" | head -1)"
            if [[ "$COMMIT_FIRST_LINE" =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
              echo "Extracted PR number from commit message: #$PR_NUM"
            elif [[ "$COMMIT_FIRST_LINE" =~ \(#([0-9]+)\) ]]; then
              # Also handle squash merge format: "feat: description (#123)"
              PR_NUM="${BASH_REMATCH[1]}"
              echo "Extracted PR number from squash commit: #$PR_NUM"
            fi
          fi

          # Build security scanners list
          SCANNERS="${{ inputs.security_scanners }}"
          if [ -z "$SCANNERS" ]; then
            SCANNERS="CodeQL, Trivy, Semgrep, OWASP Dependency Check, Gitleaks, Checkov, Kubesec"
          fi

          # Use single application name for all environments
          # Environment is tracked via u_environment field in change request
          SERVICE_NAME="Online Boutique"

          # Determine security scan status
          SECURITY_STATUS="${{ inputs.security_scan_status }}"
          CRITICAL="${{ inputs.critical_vulnerabilities }}"
          HIGH="${{ inputs.high_vulnerabilities }}"
          MEDIUM="${{ inputs.medium_vulnerabilities }}"

          # Auto-determine status if not provided
          if [ -z "$SECURITY_STATUS" ]; then
            if [ "$CRITICAL" != "0" ] || [ "$HIGH" != "0" ]; then
              SECURITY_STATUS="warning"
            else
              SECURITY_STATUS="passed"
            fi
          fi

          # Build security scan URL
          SECURITY_URL="https://github.com/${{ github.repository }}/security/code-scanning"

          # Build cluster namespace (microservices-{environment})
          CLUSTER_NAMESPACE="microservices-$ENVIRONMENT"

          # Get deployment method
          DEPLOYMENT_METHOD="${{ inputs.deployment_method }}"

          # Get application URL (may be empty if not yet deployed)
          APPLICATION_URL="${{ inputs.application_url }}"

          # Get unit test results
          UNIT_TEST_STATUS="${{ inputs.unit_test_status }}"
          UNIT_TEST_TOTAL="${{ inputs.unit_test_total }}"
          UNIT_TEST_PASSED="${{ inputs.unit_test_passed }}"
          UNIT_TEST_FAILED="${{ inputs.unit_test_failed }}"
          UNIT_TEST_COVERAGE="${{ inputs.unit_test_coverage }}"
          UNIT_TEST_URL="${{ inputs.unit_test_url }}"

          # Get SonarCloud results
          SONARCLOUD_STATUS="${{ inputs.sonarcloud_status }}"
          SONARCLOUD_BUGS="${{ inputs.sonarcloud_bugs }}"
          SONARCLOUD_VULNS="${{ inputs.sonarcloud_vulnerabilities }}"
          SONARCLOUD_SMELLS="${{ inputs.sonarcloud_code_smells }}"
          SONARCLOUD_COVERAGE="${{ inputs.sonarcloud_coverage }}"
          SONARCLOUD_DUPS="${{ inputs.sonarcloud_duplications }}"
          SONARCLOUD_URL="${{ inputs.sonarcloud_url }}"

          # Build GitHub artifact URLs for approver access
          # Base URL for this workflow run's artifacts
          BASE_ARTIFACTS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Direct link to all artifacts (approvers can download everything from here)
          GITHUB_ARTIFACTS_URL="${BASE_ARTIFACTS_URL}#artifacts"

          # Security scan results in GitHub Security tab
          SARIF_RESULTS_URL="https://github.com/${{ github.repository }}/security/code-scanning?query=is:open+ref:refs/heads/$BRANCH_NAME"

          # SBOM artifact (uploaded by security-scan workflow)
          SBOM_URL="${BASE_ARTIFACTS_URL}#:~:text=sbom.cyclonedx.json"

          # Signatures artifacts (uploaded by build-images workflow)
          SIGNATURES_URL="${BASE_ARTIFACTS_URL}#:~:text=signatures-"

          # Infrastructure discovery report (if exists)
          INFRASTRUCTURE_REPORT_URL="${BASE_ARTIFACTS_URL}#:~:text=infrastructure-discovery-"

          # Build the JSON payload using jq
          # Note: Detailed metadata (repository, commit, environment, etc.) is now stored in dedicated custom fields
          PAYLOAD=$(jq -n \
            --arg short_desc "$SHORT_DESC" \
            --arg description "$DESCRIPTION" \
            --arg type "standard" \
            --arg state "$STATE" \
            --arg priority "$PRIORITY" \
            --arg assignment_group "$ASSIGNMENT_GROUP" \
            --arg assigned_to "$ASSIGNED_TO" \
            --arg category "DevOps" \
            --arg subcategory "Deployment" \
            --arg risk "$RISK" \
            --arg impact "$IMPACT" \
            --arg urgency "3" \
            --arg justification "Automated deployment via CI/CD pipeline. Changes have been tested in lower environments and approved via pull request workflow. Security scans: $SECURITY_STATUS" \
            --arg impl_plan "$IMPL_PLAN" \
            --arg backout_plan "$BACKOUT_PLAN" \
            --arg test_plan "$TEST_PLAN" \
            --argjson cab_required "$CAB_REQUIRED" \
            --argjson prod_system "$PROD_SYSTEM" \
            --arg outside_maint "false" \
            --arg business_service "$SERVICE_NAME" \
            --arg cmdb_ci "${{ steps.get-app-ci.outputs.cmdb_ci_sys_id }}" \
            --arg u_source "GitHub Actions" \
            --arg u_env "$ENVIRONMENT" \
            --arg u_type "$CHANGE_TYPE" \
            --arg u_repo "${{ github.repository }}" \
            --arg u_workflow "${{ github.workflow }}" \
            --arg u_run_id "${{ github.run_id }}" \
            --arg u_actor "${{ github.actor }}" \
            --arg u_ref "${{ github.ref }}" \
            --arg u_sha "${{ github.sha }}" \
            --arg u_branch "$BRANCH_NAME" \
            --arg u_pr_number "$PR_NUM" \
            --arg u_services_deployed "${{ inputs.services_deployed }}" \
            --arg u_infrastructure_changes "${{ inputs.infrastructure_changes }}" \
            --arg u_security_scanners "$SCANNERS" \
            --arg u_previous_version "${{ inputs.previous_version }}" \
            --argjson u_commit_message "$COMMIT_MESSAGE" \
            --arg u_security_scan_status "$SECURITY_STATUS" \
            --arg u_critical_vulnerabilities "$CRITICAL" \
            --arg u_high_vulnerabilities "$HIGH" \
            --arg u_medium_vulnerabilities "$MEDIUM" \
            --arg u_security_scan_url "$SECURITY_URL" \
            --arg u_cluster_namespace "$CLUSTER_NAMESPACE" \
            --arg u_deployment_method "$DEPLOYMENT_METHOD" \
            --arg u_application_url "$APPLICATION_URL" \
            --arg u_unit_test_status "$UNIT_TEST_STATUS" \
            --arg u_unit_test_total "$UNIT_TEST_TOTAL" \
            --arg u_unit_test_passed "$UNIT_TEST_PASSED" \
            --arg u_unit_test_failed "$UNIT_TEST_FAILED" \
            --arg u_unit_test_coverage "$UNIT_TEST_COVERAGE" \
            --arg u_unit_test_url "$UNIT_TEST_URL" \
            --arg u_sonarcloud_status "$SONARCLOUD_STATUS" \
            --arg u_sonarcloud_bugs "$SONARCLOUD_BUGS" \
            --arg u_sonarcloud_vulnerabilities "$SONARCLOUD_VULNS" \
            --arg u_sonarcloud_code_smells "$SONARCLOUD_SMELLS" \
            --arg u_sonarcloud_coverage "$SONARCLOUD_COVERAGE" \
            --arg u_sonarcloud_duplications "$SONARCLOUD_DUPS" \
            --arg u_sonarcloud_url "$SONARCLOUD_URL" \
            --arg u_sbom_url "$SBOM_URL" \
            --arg u_signatures_url "$SIGNATURES_URL" \
            --arg u_sarif_results_url "$SARIF_RESULTS_URL" \
            --arg u_infrastructure_report_url "$INFRASTRUCTURE_REPORT_URL" \
            --arg u_github_artifacts_url "$GITHUB_ARTIFACTS_URL" \
            '{
              short_description: $short_desc,
              description: $description,
              type: $type,
              state: $state,
              priority: $priority,
              assignment_group: $assignment_group,
              assigned_to: $assigned_to,
              category: $category,
              subcategory: $subcategory,
              risk: $risk,
              impact: $impact,
              urgency: $urgency,
              justification: $justification,
              implementation_plan: $impl_plan,
              backout_plan: $backout_plan,
              test_plan: $test_plan,
              cab_required: $cab_required,
              production_system: $prod_system,
              outside_maintenance_schedule: $outside_maint,
              business_service: $business_service,
              cmdb_ci: $cmdb_ci,
              u_source: $u_source,
              u_environment: $u_env,
              u_change_type: $u_type,
              u_github_repo: $u_repo,
              u_github_workflow: $u_workflow,
              u_github_run_id: $u_run_id,
              u_github_actor: $u_actor,
              u_github_ref: $u_ref,
              u_github_sha: $u_sha,
              u_github_branch: $u_branch,
              u_github_pr_number: $u_pr_number,
              u_services_deployed: $u_services_deployed,
              u_infrastructure_changes: $u_infrastructure_changes,
              u_security_scanners: $u_security_scanners,
              u_previous_version: $u_previous_version,
              u_commit_message: $u_commit_message,
              u_security_scan_status: $u_security_scan_status,
              u_critical_vulnerabilities: $u_critical_vulnerabilities,
              u_high_vulnerabilities: $u_high_vulnerabilities,
              u_medium_vulnerabilities: $u_medium_vulnerabilities,
              u_security_scan_url: $u_security_scan_url,
              u_cluster_namespace: $u_cluster_namespace,
              u_deployment_method: $u_deployment_method,
              u_application_url: $u_application_url,
              u_unit_test_status: $u_unit_test_status,
              u_unit_test_total: $u_unit_test_total,
              u_unit_test_passed: $u_unit_test_passed,
              u_unit_test_failed: $u_unit_test_failed,
              u_unit_test_coverage: $u_unit_test_coverage,
              u_unit_test_url: $u_unit_test_url,
              u_sonarcloud_status: $u_sonarcloud_status,
              u_sonarcloud_bugs: $u_sonarcloud_bugs,
              u_sonarcloud_vulnerabilities: $u_sonarcloud_vulnerabilities,
              u_sonarcloud_code_smells: $u_sonarcloud_code_smells,
              u_sonarcloud_coverage: $u_sonarcloud_coverage,
              u_sonarcloud_duplications: $u_sonarcloud_duplications,
              u_sonarcloud_url: $u_sonarcloud_url,
              u_sbom_url: $u_sbom_url,
              u_signatures_url: $u_signatures_url,
              u_sarif_results_url: $u_sarif_results_url,
              u_infrastructure_report_url: $u_infrastructure_report_url,
              u_github_artifacts_url: $u_github_artifacts_url
            }'
          )

          echo "Creating change request in ServiceNow..."

          # Make the API call (using environment variables)
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            "$SERVICENOW_INSTANCE_URL/api/now/table/change_request")

          # Extract HTTP code and body
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" = "201" ]; then
            CHANGE_NUMBER=$(echo "$BODY" | jq -r '.result.number')
            CHANGE_SYSID=$(echo "$BODY" | jq -r '.result.sys_id')

            echo "‚úÖ Change Request Created: $CHANGE_NUMBER"
            echo "change_number=$CHANGE_NUMBER" >> $GITHUB_OUTPUT
            echo "change_sys_id=$CHANGE_SYSID" >> $GITHUB_OUTPUT

            # Add to job summary
            {
              echo "## üìù ServiceNow Change Request Created"
              echo ""
              echo "**Change Number:** $CHANGE_NUMBER"
              echo "**Environment:** ${{ inputs.environment }}"
              echo "**State:** ${{ steps.prepare.outputs.state }}"
              echo ""
              echo "üîó [View in ServiceNow]($SERVICENOW_INSTANCE_URL/change_request.do?sys_id=${CHANGE_SYSID})"
            } >> $GITHUB_STEP_SUMMARY

            exit 0
          else
            echo "‚ùå Change Request Creation Failed (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' || echo "$BODY"

            # Add to job summary
            {
              echo "## ‚ùå ServiceNow Change Request Failed"
              echo ""
              echo "**Environment:** ${{ inputs.environment }}"
              echo "**HTTP Status:** $HTTP_CODE"
              echo ""
              echo "**Error:** See job logs for details"
            } >> $GITHUB_STEP_SUMMARY

            # Don't fail the workflow for dev environment
            if [ "${{ inputs.environment }}" = "dev" ]; then
              echo "‚ö†Ô∏è  Continuing despite failure (dev environment)"
              exit 0
            else
              exit 1
            fi
          fi

      # ========================================
      # PHASE 1: DevOps Workspace Integration
      # ========================================

      - name: Link Change Request to DevOps Pipeline
        id: link-devops
        if: steps.create-cr.outputs.change_sys_id != ''
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          SN_ORCHESTRATION_TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
        run: |
          echo "üîó Linking CR $CHANGE_NUMBER to DevOps workspace..."

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X POST \
            -d '{
              "change_request": "'"$CHANGE_SYSID"'",
              "app": "${{ steps.get-app-ci.outputs.app_sys_id }}",
              "pipeline_name": "Deploy to ${{ inputs.environment }}",
              "pipeline_id": "${{ github.run_id }}",
              "pipeline_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "tool": "f62c4e49c3fcf614e1bbf0cb050131ef"
            }' \
            "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_change_reference")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

          if [ "$HTTP_CODE" = "201" ]; then
            REF_ID=$(echo "$BODY" | jq -r '.result.sys_id')
            TOOL_VALUE=$(echo "$BODY" | jq -r '.result.tool.value // .result.tool // "null"')
            echo "‚úÖ Pipeline linked to DevOps workspace (ref: $REF_ID)"
            echo "   CR now visible in: DevOps ‚Üí Change Velocity"
            echo "   Tool: $TOOL_VALUE"

            # Export REF_ID for later steps to link packages and pipeline executions
            echo "devops_ref_id=$REF_ID" >> $GITHUB_OUTPUT

            if [ "$TOOL_VALUE" = "null" ]; then
              echo "   ‚ö†Ô∏è  WARNING: Tool field is 'null' - check SN_ORCHESTRATION_TOOL_ID secret"
            fi
          else
            echo "‚ö†Ô∏è  Failed to link to DevOps workspace (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' || echo "$BODY"
          fi

      # ========================================
      # PHASE 2: Test Results Tracking
      # ========================================

      - name: Register Test Results in DevOps Workspace
        if: steps.create-cr.outputs.change_sys_id != '' && (inputs.unit_test_total != '0' || inputs.security_scan_status != '')
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          SN_ORCHESTRATION_TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
        run: |
          echo "üìä Registering test results for CR $CHANGE_NUMBER..."

          # Calculate overall test result
          UNIT_TEST_TOTAL="${{ inputs.unit_test_total }}"
          UNIT_TEST_FAILED="${{ inputs.unit_test_failed }}"
          SECURITY_STATUS="${{ inputs.security_scan_status }}"
          CRITICAL="${{ inputs.critical_vulnerabilities }}"
          HIGH="${{ inputs.high_vulnerabilities }}"

          # Determine test result
          if [ "$UNIT_TEST_FAILED" != "0" ] || [ "$CRITICAL" != "0" ]; then
            TEST_RESULT="failure"
          elif [ "$HIGH" != "0" ]; then
            TEST_RESULT="warning"
          else
            TEST_RESULT="success"
          fi

          # Register unit test results
          if [ -n "$UNIT_TEST_TOTAL" ] && [ "$UNIT_TEST_TOTAL" != "0" ]; then
            echo "  ‚Ü≥ Registering unit tests..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "change_request": "'"$CHANGE_SYSID"'",
                "test_suite_name": "Unit Tests - All Services",
                "test_result": "'"$TEST_RESULT"'",
                "test_type": "unit",
                "total_tests": '${{ inputs.unit_test_total }}',
                "passed_tests": '${{ inputs.unit_test_passed }}',
                "failed_tests": '${{ inputs.unit_test_failed }}',
                "pipeline_id": "${{ github.run_id }}",
                "pipeline_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_result")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              TEST_SYS_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ Unit test results registered"
              echo "       Test sys_id: $TEST_SYS_ID"
              echo "       Total: ${{ inputs.unit_test_total }}, Passed: ${{ inputs.unit_test_passed }}, Failed: ${{ inputs.unit_test_failed }}"
            else
              echo "    ‚ùå Failed to register unit test results (HTTP $HTTP_CODE)"
              echo "    Response: $BODY" | jq '.'
            fi
          fi

          # Register security scan results
          if [ -n "$SECURITY_STATUS" ]; then
            echo "  ‚Ü≥ Registering security scans..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "change_request": "'"$CHANGE_SYSID"'",
                "test_suite_name": "Security Scans",
                "test_result": "'"$SECURITY_STATUS"'",
                "test_type": "security",
                "total_tests": 10,
                "passed_tests": '$((10 - (${CRITICAL:-0} > 0 ? 1 : 0) - (${HIGH:-0} > 0 ? 1 : 0)))',
                "failed_tests": '$((${CRITICAL:-0} > 0 ? 1 : 0))',
                "pipeline_id": "${{ github.run_id }}",
                "pipeline_url": "https://github.com/${{ github.repository }}/security/code-scanning"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_result")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              TEST_SYS_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ Security scan results registered"
              echo "       Test sys_id: $TEST_SYS_ID"
            else
              echo "    ‚ùå Failed to register security scan results (HTTP $HTTP_CODE)"
              echo "    Response: $BODY" | jq '.'
            fi
          fi

          # Register SonarCloud results (if available)
          if [ -n "${{ inputs.sonarcloud_status }}" ]; then
            echo "  ‚Ü≥ Registering SonarCloud results..."
            SONAR_RESULT="${{ inputs.sonarcloud_status }}"
            [ "$SONAR_RESULT" = "passed" ] && SONAR_TEST_RESULT="success" || SONAR_TEST_RESULT="failure"

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "change_request": "'"$CHANGE_SYSID"'",
                "test_suite_name": "SonarCloud Quality Gate",
                "test_result": "'"$SONAR_TEST_RESULT"'",
                "test_type": "quality",
                "total_tests": 1,
                "passed_tests": '$([[ "$SONAR_RESULT" == "passed" ]] && echo "1" || echo "0")',
                "failed_tests": '$([[ "$SONAR_RESULT" != "passed" ]] && echo "1" || echo "0")',
                "pipeline_id": "${{ github.run_id }}",
                "pipeline_url": "${{ inputs.sonarcloud_url }}"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_result")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              TEST_SYS_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ SonarCloud results registered"
              echo "       Test sys_id: $TEST_SYS_ID"
            else
              echo "    ‚ùå Failed to register SonarCloud results (HTTP $HTTP_CODE)"
              echo "    Response: $BODY" | jq '.'
            fi
          fi

          # ===================================
          # 4. Smoke Test / Performance Test Summary
          # ===================================
          if [ -n "${{ inputs.smoke_test_status }}" ]; then
            echo "  ‚Ü≥ Creating smoke/performance test summary..."

            # Validate SN_ORCHESTRATION_TOOL_ID secret
            if [ -z "$SN_ORCHESTRATION_TOOL_ID" ] || [ "$SN_ORCHESTRATION_TOOL_ID" = "null" ]; then
              echo "    ‚ö†Ô∏è  WARNING: SN_ORCHESTRATION_TOOL_ID secret is not set or is null"
              echo "    This will cause the tool field to be 'null' in ServiceNow"
              echo "    Please set the secret to: f62c4e49c3fcf614e1bbf0cb050131ef (GithHubARC tool)"
            fi

            SMOKE_STATUS="${{ inputs.smoke_test_status }}"
            DURATION="${{ inputs.smoke_test_duration }}"
            [ -z "$DURATION" ] && DURATION="0"

            # Calculate times (convert duration to milliseconds for glide_time fields)
            DURATION_MS=$((DURATION * 1000))
            START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
            FINISH_TIME=$(date -u -d "+${DURATION} seconds" +"%Y-%m-%d %H:%M:%S" 2>/dev/null || date -u +"%Y-%m-%d %H:%M:%S")

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "name": "Smoke Tests - Post-Deployment (${{ inputs.environment }})",
                "tool": "f62c4e49c3fcf614e1bbf0cb050131ef",
                "url": "${{ inputs.smoke_test_url }}",
                "test_type": "functional",
                "start_time": "'"$START_TIME"'",
                "finish_time": "'"$FINISH_TIME"'",
                "duration": '$DURATION',
                "total_tests": 1,
                "passed_tests": '$([[ "$SMOKE_STATUS" == "passed" ]] && echo "1" || echo "0")',
                "failed_tests": '$([[ "$SMOKE_STATUS" != "passed" ]] && echo "1" || echo "0")',
                "skipped_tests": 0,
                "blocked_tests": 0,
                "passing_percent": '$([[ "$SMOKE_STATUS" == "passed" ]] && echo "100" || echo "0")',
                "avg_time": '$DURATION_MS',
                "min_time": '$DURATION_MS',
                "max_time": '$DURATION_MS',
                "ninety_percent": '$DURATION_MS',
                "standard_deviation": 0.0,
                "throughput": "1",
                "maximum_virtual_users": 1
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_performance_test_summary")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              SUMMARY_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              TOOL_VALUE=$(echo "$BODY" | jq -r '.result.tool.value // .result.tool // "null"')
              echo "    ‚úÖ Smoke/performance test summary created (sys_id: $SUMMARY_ID)"
              echo "       Duration: ${DURATION}s, Status: $SMOKE_STATUS, Tool: $TOOL_VALUE"

              if [ "$TOOL_VALUE" = "null" ]; then
                echo "    ‚ö†Ô∏è  WARNING: Tool field is 'null' - check SN_ORCHESTRATION_TOOL_ID secret"
              fi

              SUMMARY_COUNT=$((SUMMARY_COUNT + 1))
            else
              echo "    ‚ö†Ô∏è  Failed to create smoke/performance test summary (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' || echo "$BODY"
            fi
          fi

          echo "‚úÖ Test results registered in DevOps workspace"

      - name: Create Test Summaries in DevOps Workspace
        if: steps.create-cr.outputs.change_sys_id != ''
        continue-on-error: true
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          SN_ORCHESTRATION_TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
        run: |
          echo "üìà Creating test summaries for CR $CHANGE_NUMBER..."

          SUMMARY_COUNT=0
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")

          # ServiceNow test_type sys_id references (fixes #56)
          # These are references to sn_devops_test_type table records
          TEST_TYPE_UNIT="0bd1b86a4780395095703c72846d432b"        # UnitTest
          TEST_TYPE_SECURITY="849449ddc34d3250b71ef44c0501316f"    # Security Scan
          TEST_TYPE_QUALITY="c8944191c38d3250b71ef44c0501313d"     # Quality Gate
          TEST_TYPE_SMOKE="f2c5851e07e01010412806607bd300fb"       # Smoke (functional)

          # ===================================
          # 1. Unit Test Summary
          # ===================================
          if [ "${{ inputs.unit_test_total }}" != "0" ] && [ "${{ inputs.unit_test_total }}" != "" ]; then
            echo "  ‚Ü≥ Creating unit test summary..."

            TOTAL="${{ inputs.unit_test_total }}"
            PASSED="${{ inputs.unit_test_passed }}"
            FAILED="${{ inputs.unit_test_failed }}"

            # Calculate passing percentage
            if [ "$TOTAL" -gt 0 ]; then
              PASSING_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
            else
              PASSING_PERCENT="0.00"
            fi

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "name": "Unit Tests - All Services (${{ inputs.environment }})",
                "tool": "f62c4e49c3fcf614e1bbf0cb050131ef",
                "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "test_type": "'"$TEST_TYPE_UNIT"'",
                "total_tests": '"$TOTAL"',
                "passed_tests": '"$PASSED"',
                "failed_tests": '"$FAILED"',
                "skipped_tests": 0,
                "blocked_tests": 0,
                "passing_percent": '"$PASSING_PERCENT"',
                "start_time": "'"$CURRENT_TIME"'",
                "finish_time": "'"$CURRENT_TIME"'"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_summary")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              SUMMARY_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ Unit test summary created (sys_id: $SUMMARY_ID)"
              echo "       Total: $TOTAL, Passed: $PASSED, Failed: $FAILED, Pass Rate: $PASSING_PERCENT%"
              SUMMARY_COUNT=$((SUMMARY_COUNT + 1))
            else
              echo "    ‚ö†Ô∏è  Failed to create unit test summary (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' || echo "$BODY"
            fi
          fi

          # ===================================
          # 2. Security Scan Summary
          # ===================================
          if [ -n "${{ inputs.security_scan_status }}" ]; then
            echo "  ‚Ü≥ Creating security scan summary..."

            SECURITY_STATUS="${{ inputs.security_scan_status }}"
            CRITICAL="${{ inputs.critical_vulnerabilities }}"
            HIGH="${{ inputs.high_vulnerabilities }}"
            MEDIUM="${{ inputs.medium_vulnerabilities }}"
            LOW="${{ inputs.low_vulnerabilities }}"

            # Total scans = number of scan types (Trivy, CodeQL, Semgrep, Gitleaks)
            TOTAL_SCANS=4

            # Determine pass/fail based on vulnerabilities
            if [ "$CRITICAL" = "0" ] && [ "$HIGH" = "0" ]; then
              PASSED_SCANS=$TOTAL_SCANS
              FAILED_SCANS=0
            elif [ "$CRITICAL" != "0" ]; then
              PASSED_SCANS=0
              FAILED_SCANS=$TOTAL_SCANS
            else
              PASSED_SCANS=$((TOTAL_SCANS - 1))
              FAILED_SCANS=1
            fi

            PASSING_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($PASSED_SCANS/$TOTAL_SCANS)*100}")

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "name": "Security Scans - Trivy, CodeQL, Semgrep, Gitleaks (${{ inputs.environment }})",
                "tool": "f62c4e49c3fcf614e1bbf0cb050131ef",
                "url": "https://github.com/${{ github.repository }}/security",
                "test_type": "'"$TEST_TYPE_SECURITY"'",
                "total_tests": '"$TOTAL_SCANS"',
                "passed_tests": '"$PASSED_SCANS"',
                "failed_tests": '"$FAILED_SCANS"',
                "skipped_tests": 0,
                "blocked_tests": 0,
                "passing_percent": '"$PASSING_PERCENT"',
                "start_time": "'"$CURRENT_TIME"'",
                "finish_time": "'"$CURRENT_TIME"'"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_summary")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              SUMMARY_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ Security scan summary created (sys_id: $SUMMARY_ID)"
              echo "       Critical: $CRITICAL, High: $HIGH, Medium: $MEDIUM, Low: $LOW"
              SUMMARY_COUNT=$((SUMMARY_COUNT + 1))
            else
              echo "    ‚ö†Ô∏è  Failed to create security scan summary (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' || echo "$BODY"
            fi
          fi

          # ===================================
          # 3. SonarCloud Quality Gate Summary
          # ===================================
          if [ -n "${{ inputs.sonarcloud_status }}" ]; then
            echo "  ‚Ü≥ Creating SonarCloud quality gate summary..."

            SONAR_STATUS="${{ inputs.sonarcloud_status }}"
            BUGS="${{ inputs.sonarcloud_bugs }}"
            VULNERABILITIES="${{ inputs.sonarcloud_vulnerabilities }}"
            CODE_SMELLS="${{ inputs.sonarcloud_code_smells }}"

            # Determine pass/fail
            if [ "$SONAR_STATUS" = "passed" ]; then
              PASSED_CHECKS=1
              FAILED_CHECKS=0
              PASSING_PERCENT="100.00"
            else
              PASSED_CHECKS=0
              FAILED_CHECKS=1
              PASSING_PERCENT="0.00"
            fi

            # URL fallback - use GitHub Actions run if SonarCloud URL not provided (fixes #56)
            SONAR_URL="${{ inputs.sonarcloud_url }}"
            [ -z "$SONAR_URL" ] && SONAR_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "name": "SonarCloud Quality Gate (${{ inputs.environment }})",
                "tool": "f62c4e49c3fcf614e1bbf0cb050131ef",
                "url": "'"$SONAR_URL"'",
                "test_type": "'"$TEST_TYPE_QUALITY"'",
                "total_tests": 1,
                "passed_tests": '"$PASSED_CHECKS"',
                "failed_tests": '"$FAILED_CHECKS"',
                "skipped_tests": 0,
                "blocked_tests": 0,
                "passing_percent": '"$PASSING_PERCENT"',
                "start_time": "'"$CURRENT_TIME"'",
                "finish_time": "'"$CURRENT_TIME"'"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_summary")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              SUMMARY_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ SonarCloud summary created (sys_id: $SUMMARY_ID)"
              echo "       Status: $SONAR_STATUS, Bugs: $BUGS, Vulnerabilities: $VULNERABILITIES, Code Smells: $CODE_SMELLS"
              SUMMARY_COUNT=$((SUMMARY_COUNT + 1))
            else
              echo "    ‚ö†Ô∏è  Failed to create SonarCloud summary (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' || echo "$BODY"
            fi
          fi

          # ===================================
          # 4. Smoke Test Summary (if available)
          # ===================================
          if [ -n "${{ inputs.smoke_test_status }}" ]; then
            echo "  ‚Ü≥ Creating smoke test summary..."

            SMOKE_STATUS="${{ inputs.smoke_test_status }}"
            DURATION="${{ inputs.smoke_test_duration }}"
            [ -z "$DURATION" ] && DURATION="0"

            if [ "$SMOKE_STATUS" = "passed" ]; then
              PASSED_TESTS=1
              FAILED_TESTS=0
              PASSING_PERCENT="100.00"
            else
              PASSED_TESTS=0
              FAILED_TESTS=1
              PASSING_PERCENT="0.00"
            fi

            # URL fallback - use GitHub Actions run if smoke test URL not provided (fixes #56)
            SMOKE_URL="${{ inputs.smoke_test_url }}"
            [ -z "$SMOKE_URL" ] && SMOKE_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "name": "Smoke Tests - Post-Deployment Verification (${{ inputs.environment }})",
                "tool": "f62c4e49c3fcf614e1bbf0cb050131ef",
                "url": "'"$SMOKE_URL"'",
                "test_type": "'"$TEST_TYPE_SMOKE"'",
                "total_tests": 1,
                "passed_tests": '"$PASSED_TESTS"',
                "failed_tests": '"$FAILED_TESTS"',
                "skipped_tests": 0,
                "blocked_tests": 0,
                "passing_percent": '"$PASSING_PERCENT"',
                "duration": '"$DURATION"',
                "start_time": "'"$CURRENT_TIME"'",
                "finish_time": "'"$CURRENT_TIME"'"
              }' \
              "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_test_summary")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" = "201" ]; then
              SUMMARY_ID=$(echo "$BODY" | jq -r '.result.sys_id')
              echo "    ‚úÖ Smoke test summary created (sys_id: $SUMMARY_ID)"
              echo "       Status: $SMOKE_STATUS, Duration: ${DURATION}s"
              SUMMARY_COUNT=$((SUMMARY_COUNT + 1))
            else
              echo "    ‚ö†Ô∏è  Failed to create smoke test summary (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' || echo "$BODY"
            fi
          fi

          # Summary
          if [ $SUMMARY_COUNT -gt 0 ]; then
            echo ""
            echo "‚úÖ Created $SUMMARY_COUNT test summary/summaries in DevOps workspace"
            echo "   View at: $SERVICENOW_INSTANCE_URL/sn_devops_test_summary_list.do"
          else
            echo ""
            echo "‚ö†Ô∏è  No test summaries were created"
          fi

      # ========================================
      # PHASE 3: Work Items Integration
      # ========================================

      - name: Extract and Register Work Items
        if: steps.create-cr.outputs.change_sys_id != ''
        continue-on-error: true
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          COMMIT_MESSAGE: ${{ toJSON(github.event.head_commit.message) }}
          # ServiceNow API credentials
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
        run: |
          echo "üîó Extracting work items from commits for CR $CHANGE_NUMBER..."

          # Extract issue numbers from commit message
          # COMMIT_MESSAGE is JSON-escaped, so parse it with jq first to get the raw string
          COMMIT_RAW=$(echo "$COMMIT_MESSAGE" | jq -r '.')
          # Looks for: Fixes #7, Closes #123, Resolves #456, etc.
          ISSUES=$(echo "$COMMIT_RAW" | grep -oP '(?:Fixes|Closes|Resolves|References|Refs|Issue|#)\s*#?\K\d+' | sort -u)

          if [ -z "$ISSUES" ]; then
            echo "  No issue references found in commit message"
          else
            echo "  Found issue references: $(echo $ISSUES | tr '\n' ' ')"

            for ISSUE_NUM in $ISSUES; do
              echo "  ‚Ü≥ Registering GitHub Issue #$ISSUE_NUM..."

              # Get issue details from GitHub API
              ISSUE_DATA=$(curl -s \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")

              ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title // "GitHub Issue #'"$ISSUE_NUM"'"')
              ISSUE_STATE=$(echo "$ISSUE_DATA" | jq -r '.state // "unknown"')

              # Register work item in ServiceNow
              curl -s \
                -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
                -H "Content-Type: application/json" \
                -X POST \
                -d '{
                  "change_request": "'"$CHANGE_SYSID"'",
                  "work_item_id": "'"$ISSUE_NUM"'",
                  "work_item_type": "GitHub Issue",
                  "work_item_url": "https://github.com/${{ github.repository }}/issues/'"$ISSUE_NUM"'",
                  "work_item_title": "'"$(echo "$ISSUE_TITLE" | sed 's/"/\\"/g')"'",
                  "work_item_state": "'"$ISSUE_STATE"'"
                }' \
                "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_work_item" > /dev/null

              echo "    ‚úÖ Issue #$ISSUE_NUM registered"
            done

            echo "‚úÖ Work items linked to CR"
          fi

      # ========================================
      # PHASE 4: Application Registration (REMOVED - Now done before CR creation)
      # ========================================
      # NOTE: Application CI registration has been moved to "Get or Create Application CI" step
      # This ensures cmdb_ci field is populated during initial change request creation
      # instead of being patched afterwards. See issue #54 for details.

      # ========================================
      # PHASE 5: Artifact Tracking
      # ========================================

      - name: Register Deployed Artifacts
        if: steps.create-cr.outputs.change_sys_id != '' && inputs.services_deployed != '[]' && inputs.services_deployed != ''
        continue-on-error: true
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          SERVICES: ${{ inputs.services_deployed }}
          # ServiceNow API credentials
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
        run: |
          echo "üì¶ Registering deployed artifacts for CR $CHANGE_NUMBER..."

          # Get version from previous_version input or use github.sha as fallback
          VERSION="${{ inputs.previous_version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.sha }}"
            VERSION="${VERSION:0:7}"
          fi

          # Parse services JSON array and register each artifact
          SERVICE_COUNT=$(echo "$SERVICES" | jq -r 'length')

          if [ "$SERVICE_COUNT" -gt 0 ]; then
            echo "  Found $SERVICE_COUNT service(s) to register"

            echo "$SERVICES" | jq -r '.[]' | while read -r SERVICE; do
              echo "  ‚Ü≥ Registering $SERVICE..."

              # Determine ECR URL based on AWS account and region
              ECR_URL="533267307120.dkr.ecr.eu-west-2.amazonaws.com/$SERVICE:$VERSION"

              curl -s \
                -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
                -H "Content-Type: application/json" \
                -X POST \
                -d '{
                  "change_request": "'"$CHANGE_SYSID"'",
                  "artifact_name": "'"$SERVICE"'",
                  "artifact_version": "'"$VERSION"'",
                  "artifact_type": "container_image",
                  "artifact_url": "'"$ECR_URL"'",
                  "artifact_repository": "AWS ECR",
                  "deployment_environment": "${{ inputs.environment }}",
                  "pipeline_id": "${{ github.run_id }}"
                }' \
                "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_artifact" > /dev/null

              echo "    ‚úÖ $SERVICE registered"
            done

            echo "‚úÖ Deployed artifacts registered in DevOps workspace"
          else
            echo "  No services to register"
          fi

      # ========================================
      # PHASE 6: Package Registration (Using ServiceNow DevOps GitHub Action)
      # ========================================
      # This replaces the previous REST API approach which didn't create proper linkages.
      # The ServiceNow DevOps action automatically handles:
      # - Creating pipeline_execution records
      # - Linking package ‚Üí pipeline_execution ‚Üí pipeline ‚Üí application
      # - All packages will now appear in DevOps Insights dashboard

      - name: Prepare Package Artifacts
        id: prepare-artifacts
        if: steps.create-cr.outputs.change_sys_id != ''
        run: |
          # Package version: use previous_version if provided, else short SHA
          VERSION="${{ inputs.previous_version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.sha }}"
            VERSION="${VERSION:0:7}"
          fi

          PACKAGE_NAME="microservices-demo-${{ inputs.environment }}-$VERSION"

          # Format artifacts for ServiceNow DevOps action (JSON must be single line)
          # This creates the package with proper linkages
          ARTIFACTS='[{"name": "microservices-demo", "version": "'"$VERSION"'", "semanticVersion": "'"$VERSION"'", "repositoryName": "${{ github.repository }}"}]'

          echo "artifacts=$ARTIFACTS" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "üì¶ Prepared package for registration:"
          echo "  Package name: $PACKAGE_NAME"
          echo "  Version: $VERSION"
          echo "  Artifacts: $ARTIFACTS"

      - name: Register Package with ServiceNow DevOps
        id: register-package
        if: steps.create-cr.outputs.change_sys_id != ''
        uses: ServiceNow/servicenow-devops-register-package@v3.1.0
        with:
          devops-integration-user-name: ${{ secrets.SERVICENOW_USERNAME }}
          devops-integration-user-password: ${{ secrets.SERVICENOW_PASSWORD }}
          instance-url: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          tool-id: 'f62c4e49c3fcf614e1bbf0cb050131ef'  # GithHubARC tool
          context-github: ${{ toJSON(github) }}
          job-name: 'Register Package - ${{ inputs.environment }}'
          artifacts: ${{ steps.prepare-artifacts.outputs.artifacts }}
          package-name: ${{ steps.prepare-artifacts.outputs.package_name }}

      - name: Get Package SysID
        id: get-package-sysid
        if: steps.register-package.conclusion == 'success'
        continue-on-error: true  # Don't fail workflow if package not found
        env:
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          PACKAGE_NAME: ${{ steps.prepare-artifacts.outputs.package_name }}
        run: |
          echo "üîç Looking up package sys_id for: $PACKAGE_NAME"

          # Wait a few seconds for ServiceNow to process the package registration
          sleep 5

          # Query for the package that was just created
          PACKAGE_RESPONSE=$(curl -s \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_package?sysparm_query=name=$PACKAGE_NAME&sysparm_limit=1&sysparm_display_value=all")

          PACKAGE_SYS_ID=$(echo "$PACKAGE_RESPONSE" | jq -r '.result[0].sys_id.value // empty')
          PACKAGE_APP=$(echo "$PACKAGE_RESPONSE" | jq -r '.result[0].application.display_value // "null"')

          if [ -n "$PACKAGE_SYS_ID" ]; then
            echo "‚úÖ Package registered successfully!"
            echo "  Package sys_id: $PACKAGE_SYS_ID"
            echo "  Application: $PACKAGE_APP"
            echo "package_sys_id=$PACKAGE_SYS_ID" >> $GITHUB_OUTPUT

            # Verify linkage chain
            if [ "$PACKAGE_APP" = "null" ]; then
              echo "‚ö†Ô∏è  WARNING: Package has no application linkage yet"
              echo "  This may be normal - linkage happens via pipeline_execution"
            else
              echo "‚úÖ Package successfully linked to application: $PACKAGE_APP"
            fi
          else
            echo "‚ö†Ô∏è  Package not found in ServiceNow (may not have been created)"
            echo "  This is expected when no services were built/deployed"
            echo "  Response: $(echo "$PACKAGE_RESPONSE" | jq '.')"
            # Don't exit 1 - allow workflow to continue
          fi

      - name: Link Package to Change Request
        id: link-package-to-cr
        if: steps.get-package-sysid.outputs.package_sys_id != ''
        env:
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          PACKAGE_SYS_ID: ${{ steps.get-package-sysid.outputs.package_sys_id }}
        run: |
          echo "  ‚Ü≥ Linking package to change request..."

          UPDATE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X PATCH \
            -d '{
              "u_package": "'"$PACKAGE_SYS_ID"'"
            }' \
            "$SERVICENOW_INSTANCE_URL/api/now/table/change_request/$CHANGE_SYSID")

          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2 | tr -d ' ')
          [ -z "$HTTP_CODE" ] && HTTP_CODE="000"
          BODY=$(echo "$UPDATE_RESPONSE" | sed 's/HTTP_CODE:.*//')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "    ‚úÖ Package linked to change request"
            echo "       Change request: $CHANGE_NUMBER"
            echo "       Package sys_id: $PACKAGE_SYS_ID"
          else
            echo "    ‚ùå Failed to link package (HTTP $HTTP_CODE)"
            echo "    Response body:"
            echo "$BODY" | jq '.'
            echo "    This means package exists but is NOT linked to change request"
          fi

      - name: Link Package to DevOps Change Reference
        if: steps.link-devops.outputs.devops_ref_id != '' && steps.get-package-sysid.outputs.package_sys_id != ''
        env:
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          DEVOPS_REF_ID: ${{ steps.link-devops.outputs.devops_ref_id }}
          PACKAGE_SYS_ID: ${{ steps.get-package-sysid.outputs.package_sys_id }}
        run: |
          echo "üîó Linking package to DevOps Change Reference..."

          UPDATE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X PATCH \
            -d '{
              "package_ref": "'"$PACKAGE_SYS_ID"'"
            }' \
            "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_change_reference/$DEVOPS_REF_ID")

          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2 | tr -d ' ')
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Package linked to DevOps Change Reference"
            echo "   Reference ID: $DEVOPS_REF_ID"
            echo "   Package ID: $PACKAGE_SYS_ID"
          else
            echo "‚ö†Ô∏è Failed to link package to DevOps Change Reference (HTTP $HTTP_CODE)"
            echo "$UPDATE_RESPONSE" | sed 's/HTTP_CODE:.*//' | jq '.' || echo "$UPDATE_RESPONSE"
          fi

      # ========================================
      # PHASE 7: Pipeline Execution Tracking
      # ========================================

      - name: Register Pipeline Execution
        id: register-pipeline
        if: steps.create-cr.outputs.change_sys_id != ''
        env:
          CHANGE_SYSID: ${{ steps.create-cr.outputs.change_sys_id }}
          CHANGE_NUMBER: ${{ steps.create-cr.outputs.change_number }}
          COMMIT_MESSAGE: ${{ toJSON(github.event.head_commit.message) }}
          # ServiceNow API credentials
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          SN_ORCHESTRATION_TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
        run: |
          echo "üöÄ Registering pipeline execution for CR $CHANGE_NUMBER..."

          # Calculate execution metadata
          START_TIME="${{ github.event.repository.pushed_at }}"
          if [ -z "$START_TIME" ]; then
            START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
          fi

          # Determine execution status based on workflow state
          EXECUTION_STATUS="in_progress"
          if [ "${{ job.status }}" = "success" ]; then
            EXECUTION_STATUS="successful"
          elif [ "${{ job.status }}" = "failure" ]; then
            EXECUTION_STATUS="failed"
          elif [ "${{ job.status }}" = "cancelled" ]; then
            EXECUTION_STATUS="cancelled"
          fi

          # Build JSON payload using jq to properly escape all special characters
          # Note: COMMIT_MESSAGE is JSON-escaped via toJSON(), so we pass it through jq's --argjson
          # NOTE: sn_devops_pipeline_execution does NOT have 'application' field in schema
          # Application linkage: pipeline_execution ‚Üí pipeline ‚Üí app (automatic via pipeline_url/name)
          PAYLOAD=$(jq -n \
            --arg change_request "$CHANGE_SYSID" \
            --arg pipeline_name "üöÄ Master CI/CD Pipeline" \
            --arg pipeline_id "${{ github.run_id }}" \
            --arg pipeline_url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg execution_number "${{ github.run_number }}" \
            --arg execution_status "$EXECUTION_STATUS" \
            --arg start_time "$START_TIME" \
            --arg environment "${{ inputs.environment }}" \
            --arg triggered_by "${{ github.actor }}" \
            --arg trigger_event "${{ github.event_name }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg commit_sha "${{ github.sha }}" \
            --argjson commit_message "$COMMIT_MESSAGE" \
            --arg repository "${{ github.repository }}" \
            --arg tool "f62c4e49c3fcf614e1bbf0cb050131ef" \
            --arg workflow_file "${{ github.workflow }}" \
            '{
              change_request: $change_request,
              pipeline_name: $pipeline_name,
              pipeline_id: $pipeline_id,
              pipeline_url: $pipeline_url,
              execution_number: $execution_number,
              execution_status: $execution_status,
              start_time: $start_time,
              environment: $environment,
              triggered_by: $triggered_by,
              trigger_event: $trigger_event,
              branch: $branch,
              commit_sha: $commit_sha,
              commit_message: $commit_message,
              repository: $repository,
              tool: $tool,
              workflow_file: $workflow_file
            }')

          # Register pipeline execution in sn_devops_pipeline_execution
          EXEC_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_pipeline_execution")

          HTTP_CODE=$(echo "$EXEC_RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2 | tr -d ' ')
          [ -z "$HTTP_CODE" ] && HTTP_CODE="000"
          BODY=$(echo "$EXEC_RESPONSE" | sed 's/HTTP_CODE:.*//')

          if [ "$HTTP_CODE" = "201" ]; then
            EXECUTION_SYS_ID=$(echo "$BODY" | jq -r '.result.sys_id')
            echo "  ‚úÖ Pipeline execution registered"
            echo "     Execution ID: $EXECUTION_SYS_ID"
            echo "     Status: $EXECUTION_STATUS"
            echo "     Run: ${{ github.run_number }}"
            echo "     Change Request: $CHANGE_NUMBER"
            echo "     Response: $(echo "$BODY" | jq -c '{sys_id: .result.sys_id, status: .result.execution_status, pipeline_id: .result.pipeline_id}')"
            echo "‚úÖ Pipeline: üöÄ Master CI/CD Pipeline (#${{ github.run_number }})"

            # Export pipeline execution sys_id for linking to DevOps Change Reference
            echo "pipeline_execution_sys_id=$EXECUTION_SYS_ID" >> $GITHUB_OUTPUT
          else
            echo "  ‚ùå Failed to register pipeline execution (HTTP $HTTP_CODE)"
            echo "  Response body:"
            echo "$BODY" | jq '.'
            echo "  This failure means pipeline executions are NOT being tracked in ServiceNow"
            echo "  Without pipeline executions, DevOps Insights cannot aggregate data"
          fi

      - name: Link Pipeline Execution to DevOps Change Reference
        if: steps.link-devops.outputs.devops_ref_id != '' && steps.register-pipeline.outputs.pipeline_execution_sys_id != ''
        env:
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          DEVOPS_REF_ID: ${{ steps.link-devops.outputs.devops_ref_id }}
          PIPELINE_EXEC_ID: ${{ steps.register-pipeline.outputs.pipeline_execution_sys_id }}
        run: |
          echo "üîó Linking pipeline execution to DevOps Change Reference..."

          UPDATE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -X PATCH \
            -d '{
              "pipeline_executions": "'"$PIPELINE_EXEC_ID"'"
            }' \
            "$SERVICENOW_INSTANCE_URL/api/now/table/sn_devops_change_reference/$DEVOPS_REF_ID")

          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2 | tr -d ' ')
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Pipeline execution linked to DevOps Change Reference"
            echo "   Reference ID: $DEVOPS_REF_ID"
            echo "   Pipeline Execution ID: $PIPELINE_EXEC_ID"
          else
            echo "‚ö†Ô∏è Failed to link pipeline execution to DevOps Change Reference (HTTP $HTTP_CODE)"
            echo "$UPDATE_RESPONSE" | sed 's/HTTP_CODE:.*//' | jq '.' || echo "$UPDATE_RESPONSE"
          fi

      - name: Wait for Change Approval (QA/PROD)
        if: inputs.environment != 'dev' && steps.create-cr.outputs.change_number != ''
        env:
          # ServiceNow API credentials
          SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
          SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
          SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
        run: |
          CHANGE_SYSID="${{ steps.create-cr.outputs.change_sys_id }}"
          CHANGE_NUMBER="${{ steps.create-cr.outputs.change_number }}"

          echo "‚è≥ Waiting for approval of Change Request: $CHANGE_NUMBER"
          echo "üîó View: $SERVICENOW_INSTANCE_URL/change_request.do?sys_id=${CHANGE_SYSID}"

          MAX_WAIT=3600  # 1 hour
          ELAPSED=0
          INTERVAL=60    # Check every 60 seconds

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get current state
            RESPONSE=$(curl -s \
              -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
              "$SERVICENOW_INSTANCE_URL/api/now/table/change_request/${CHANGE_SYSID}?sysparm_fields=state,approval")

            STATE=$(echo "$RESPONSE" | jq -r '.result.state')
            APPROVAL=$(echo "$RESPONSE" | jq -r '.result.approval')

            echo "Current state: $STATE, Approval: $APPROVAL"

            # State values: -5=New, -4=Assess, -3=Authorize, -2=Scheduled, -1=Implement, 0=Review, 3=Closed
            # Approval values: not_requested, requested, approved, rejected

            # Accept Scheduled (-2), Implement (-1), or Review (0) states with approved status
            if [ "$APPROVAL" = "approved" ] && ([ "$STATE" = "-2" ] || [ "$STATE" = "-1" ] || [ "$STATE" = "0" ]); then
              echo "‚úÖ Change Request approved (state: $STATE) and ready for deployment"
              exit 0
            elif [ "$APPROVAL" = "rejected" ]; then
              echo "‚ùå Change Request was rejected"
              exit 1
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "Waited ${ELAPSED}s / ${MAX_WAIT}s..."
          done

          echo "‚è±Ô∏è  Timeout waiting for approval after ${MAX_WAIT}s"
          exit 1
