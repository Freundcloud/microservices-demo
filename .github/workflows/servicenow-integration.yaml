---
name: "ServiceNow DevOps Integration (Reusable)"

"on":
  workflow_call:
    inputs:
      environment:
        description: 'Environment being deployed (dev/qa/prod)'
        required: true
        type: string
      change_type:
        description: 'Type of change (normal/standard/emergency)'
        required: false
        type: string
        default: 'normal'
      security_scan_status:
        description: 'Overall security scan status (PASSED/FAILED/UNKNOWN)'
        required: false
        type: string
        default: 'UNKNOWN'
      security_findings:
        description: 'Number of security findings'
        required: false
        type: string
        default: '0'
    outputs:
      change_request_number:
        description: "ServiceNow change request number"
        value: ${{ jobs.create-change-request.outputs.change_request_number }}
      change_request_sys_id:
        description: "ServiceNow change request sys_id"
        value: ${{ jobs.create-change-request.outputs.change_request_sys_id }}
      change_status:
        description: "Change request status"
        value: ${{ jobs.create-change-request.outputs.change_status }}

permissions:
  contents: read

env:
  SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}

jobs:
  # Job 1: Register Build Artifacts in ServiceNow DevOps
  register-artifacts:
    name: Register Artifacts in ServiceNow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Register Docker Images as Artifacts
        uses: ServiceNow/servicenow-devops-register-artifact@v3.1.0
        with:
          devops-integration-user-name: ${{ secrets.SERVICENOW_USERNAME }}
          devops-integration-user-password: ${{ secrets.SERVICENOW_PASSWORD }}
          instance-url: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'Register Artifacts in ServiceNow'
          artifacts: |
            [
              {"name": "online-boutique-frontend", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-cartservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-productcatalogservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-currencyservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-paymentservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-shippingservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-emailservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-checkoutservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-recommendationservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-adservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-loadgenerator", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"},
              {"name": "online-boutique-shoppingassistantservice", "version": "1.0.${{ github.run_number }}", "semanticVersion": "1.0.${{ github.run_number }}", "repositoryName": "${{ github.repository }}"}
            ]

      - name: Artifact Registration Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Artifacts Registered in ServiceNow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| online-boutique (12 services) | 1.0.${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View in ServiceNow DevOps](${{ secrets.SERVICENOW_INSTANCE_URL }}/now/devops-change/insights-home)" >> $GITHUB_STEP_SUMMARY

  # Job 2: Create ServiceNow Change Request
  create-change-request:
    name: Create ServiceNow Change Request
    runs-on: ubuntu-latest
    needs: register-artifacts
    outputs:
      change_request_number: ${{ steps.create-change.outputs.change-request-number }}
      change_request_sys_id: ${{ steps.create-change.outputs.change-request-sys-id }}
      change_status: ${{ steps.create-change.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Change Risk Level
        id: risk
        run: |
          # Set risk level based on environment
          case "${{ inputs.environment }}" in
            dev)
              echo "risk=low" >> $GITHUB_OUTPUT
              echo "timeout=1800" >> $GITHUB_OUTPUT  # 30 minutes
              ;;
            qa)
              echo "risk=moderate" >> $GITHUB_OUTPUT
              echo "timeout=3600" >> $GITHUB_OUTPUT  # 1 hour
              ;;
            prod)
              echo "risk=high" >> $GITHUB_OUTPUT
              echo "timeout=7200" >> $GITHUB_OUTPUT  # 2 hours
              ;;
            *)
              echo "risk=moderate" >> $GITHUB_OUTPUT
              echo "timeout=3600" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Create Change Request via ServiceNow REST API
        id: create-change
        run: |
          echo "## ðŸŽ« Creating Change Request in ServiceNow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Let ServiceNow handle approval workflows based on its configuration
          # (github_integration user doesn't have permission to set approval/state fields)

          # yamllint disable rule:line-length
          PAYLOAD='{"category":"DevOps","devops_change":true,"short_description":"Deploy Online Boutique to ENV_PLACEHOLDER","description":"Automated deployment via GitHub Actions.\n\nRepo: REPO_PLACEHOLDER\nEnv: ENV_PLACEHOLDER\nCommit: COMMIT_PLACEHOLDER\nTriggered by: ACTOR_PLACEHOLDER\nWorkflow: WORKFLOW_URL_PLACEHOLDER\n\nSecurity: SECURITY_STATUS_PLACEHOLDER\nFindings: SECURITY_FINDINGS_PLACEHOLDER","implementation_plan":"1. Deploy using Kustomize\n2. Apply to namespace: microservices-ENV_PLACEHOLDER\n3. Wait for deployments (timeout: 10min)\n4. Verify health checks\n5. Test frontend endpoint","backout_plan":"1. kubectl rollout undo deployment --all -n microservices-ENV_PLACEHOLDER\nOR\n2. kubectl delete -k kustomize/overlays/ENV_PLACEHOLDER\n3. Redeploy previous version\n4. Verify rollback","test_plan":"1. Verify pods running in microservices-ENV_PLACEHOLDER\n2. Get ingress gateway URL\n3. Test frontend endpoint (HTTP 200)\n4. Check Istio mesh connectivity\n5. Verify health endpoints","risk":"RISK_PLACEHOLDER","correlation_id":"WORKFLOW_RUN_ID_PLACEHOLDER","u_github_repo":"REPO_PLACEHOLDER","u_github_commit":"COMMIT_PLACEHOLDER","u_tool_id":"TOOL_ID_PLACEHOLDER"}'
          # yamllint enable rule:line-length

          # Replace placeholders
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|ENV_PLACEHOLDER|${{ inputs.environment }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|REPO_PLACEHOLDER|${{ github.repository }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|COMMIT_PLACEHOLDER|${{ github.sha }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|ACTOR_PLACEHOLDER|${{ github.actor }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|WORKFLOW_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|SECURITY_STATUS_PLACEHOLDER|${{ inputs.security_scan_status }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|SECURITY_FINDINGS_PLACEHOLDER|${{ inputs.security_findings }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|RISK_PLACEHOLDER|${{ steps.risk.outputs.risk }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|WORKFLOW_RUN_ID_PLACEHOLDER|${{ github.run_id }}|g")
          PAYLOAD=$(echo "$PAYLOAD" | sed "s|TOOL_ID_PLACEHOLDER|${{ secrets.SN_ORCHESTRATION_TOOL_ID }}|g")

          echo "Creating change request (Environment: ${{ inputs.environment }})..."

          # Create change request
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -d "$PAYLOAD" \
            "https://calitiiltddemo3.service-now.com/api/now/table/change_request")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "201" ]; then
            echo "âŒ ERROR: Failed to create change request (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response: $BODY" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Extract change request details
          CHANGE_NUMBER=$(echo "$BODY" | jq -r '.result.number // empty')
          CHANGE_SYS_ID=$(echo "$BODY" | jq -r '.result.sys_id // empty')

          if [ -z "$CHANGE_NUMBER" ] || [ -z "$CHANGE_SYS_ID" ]; then
            echo "âŒ ERROR: Could not extract change request details" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "change-request-number=$CHANGE_NUMBER" >> $GITHUB_OUTPUT
          echo "change-request-sys-id=$CHANGE_SYS_ID" >> $GITHUB_OUTPUT
          echo "outcome=success" >> $GITHUB_OUTPUT

          echo "âœ… Change request created: $CHANGE_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "Sys ID: $CHANGE_SYS_ID" >> $GITHUB_STEP_SUMMARY
          echo "Approval workflow will be handled by ServiceNow based on environment configuration" >> $GITHUB_STEP_SUMMARY

      - name: Validate Change Request Creation
        run: |
          CHANGE_NUMBER="${{ steps.create-change.outputs.change-request-number }}"
          CHANGE_SYS_ID="${{ steps.create-change.outputs.change-request-sys-id }}"

          if [ -z "$CHANGE_NUMBER" ] || [ "$CHANGE_NUMBER" == "" ]; then
            echo "âŒ ERROR: Change request number not returned" >> $GITHUB_STEP_SUMMARY
            echo "ServiceNow DevOps Change API call failed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "## âœ… Change Request Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Number | **$CHANGE_NUMBER** |" >> $GITHUB_STEP_SUMMARY
          echo "| Sys ID | \`$CHANGE_SYS_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **${{ inputs.environment }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Level | ${{ steps.risk.outputs.risk }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View in ServiceNow](${{ secrets.SERVICENOW_INSTANCE_URL }}/nav_to.do?uri=change_request.do?sys_id=$CHANGE_SYS_ID)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [DevOps Workspace](${{ secrets.SERVICENOW_INSTANCE_URL }}/now/devops-change/home)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Upload Security Evidence to Change Request
  upload-security-evidence:
    name: Upload Security Evidence
    runs-on: ubuntu-latest
    needs: create-change-request
    if: always() && needs.create-change-request.outputs.change_request_sys_id != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security scan artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Upload Security Evidence Files
        run: |
          CHANGE_SYS_ID="${{ needs.create-change-request.outputs.change_request_sys_id }}"
          CHANGE_NUMBER="${{ needs.create-change-request.outputs.change_request_number }}"
          BASIC_AUTH=$(echo -n "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" | base64)

          echo "ðŸ“¤ Uploading security evidence to Change Request $CHANGE_NUMBER..."

          UPLOADED_COUNT=0

          # Upload security evidence report
          if [ -f "security-scan-evidence/security-scan-evidence.md" ]; then
            curl -s -w "\n%{http_code}" \
              -H "Authorization: Basic $BASIC_AUTH" \
              -F "file=@security-scan-evidence/security-scan-evidence.md" \
              -F "file_name=security-scan-evidence-${{ github.run_number }}.md" \
              -F "table_name=change_request" \
              -F "table_sys_id=$CHANGE_SYS_ID" \
              "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/attachment/upload" > /dev/null
            echo "âœ… Uploaded: security-scan-evidence.md"
            UPLOADED_COUNT=$((UPLOADED_COUNT + 1))
          fi

          # Upload SARIF files
          shopt -s nullglob  # Prevent errors if no .sarif files exist
          for sarif_file in security-scan-evidence/*.sarif; do
            if [ -f "$sarif_file" ]; then
              curl -s -w "\n%{http_code}" \
                -H "Authorization: Basic $BASIC_AUTH" \
                -F "file=@$sarif_file" \
                -F "table_name=change_request" \
                -F "table_sys_id=$CHANGE_SYS_ID" \
                "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/attachment/upload" > /dev/null
              echo "âœ… Uploaded: $(basename $sarif_file)"
              UPLOADED_COUNT=$((UPLOADED_COUNT + 1))
            fi
          done
          shopt -u nullglob  # Restore default behavior

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… UPLOADED $UPLOADED_COUNT FILES TO SERVICENOW"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Add Work Note with Security Summary
        run: |
          CHANGE_SYS_ID="${{ needs.create-change-request.outputs.change_request_sys_id }}"
          STATUS="${{ inputs.security_scan_status }}"
          FINDINGS="${{ inputs.security_findings }}"
          WORKFLOW="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Build status message based on scan results
          if [ "$STATUS" == "PASSED" ]; then
            STATUS_MSG="âœ… All security scans passed - Safe to proceed"
          elif [ "$STATUS" == "FAILED" ]; then
            STATUS_MSG="âš ï¸ REVIEW REQUIRED: $FINDINGS findings detected"
          else
            STATUS_MSG="â„¹ï¸ Security scans completed - review attached evidence"
          fi

          # Create work note payload
          WORK_NOTE="ðŸ”’ SECURITY SCAN EVIDENCE UPLOADED\n\nSecurity Scan Status: $STATUS\n$STATUS_MSG\n\nEvidence: SARIF results + summary report\nWorkflow: $WORKFLOW\nCompliance: SOC 2 CC7.1 security controls"
          PAYLOAD=$(jq -n --arg note "$WORK_NOTE" '{work_notes: $note}')

          curl -s -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${{ secrets.SERVICENOW_USERNAME }}:${{ secrets.SERVICENOW_PASSWORD }}" \
            -d "$PAYLOAD" \
            "${{ secrets.SERVICENOW_INSTANCE_URL }}/api/now/table/change_request/$CHANGE_SYS_ID" > /dev/null

          echo "âœ… Work note added to change request" >> $GITHUB_STEP_SUMMARY

  # Job 4: Register Security Scan Results
  register-security-results:
    name: Register Security Results
    runs-on: ubuntu-latest
    needs: create-change-request
    if: always() && needs.create-change-request.outputs.change_request_sys_id != ''

    strategy:
      fail-fast: false
      matrix:
        scanner:
          - {name: "CodeQL-Python", id: "codeql-python"}
          - {name: "CodeQL-JavaScript", id: "codeql-javascript"}
          - {name: "CodeQL-Go", id: "codeql-go"}
          - {name: "CodeQL-Java", id: "codeql-java"}
          - {name: "CodeQL-CSharp", id: "codeql-csharp"}
          - {name: "Semgrep", id: "semgrep"}
          - {name: "Trivy", id: "trivy"}
          - {name: "Checkov", id: "checkov"}
          - {name: "tfsec", id: "tfsec"}
          - {name: "Polaris", id: "polaris"}

    steps:
      - name: Register ${{ matrix.scanner.name }} Results
        uses: ServiceNow/servicenow-devops-security-result@v3.1.0
        # Removed continue-on-error to expose real API failures for troubleshooting
        with:
          devops-integration-user-name: ${{ secrets.SERVICENOW_USERNAME }}
          devops-integration-user-password: ${{ secrets.SERVICENOW_PASSWORD }}
          instance-url: ${{ secrets.SERVICENOW_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'Register Security Results (${{ matrix.scanner.name }})'
          security-result-attributes: >
            {
              "scanner": "${{ matrix.scanner.name }}",
              "projectName": "${{ github.repository }}",
              "scanId": "${{ github.run_id }}-${{ matrix.scanner.id }}",
              "securityToolId": "${{ matrix.scanner.id }}",
              "changeRequestNumber": "${{ needs.create-change-request.outputs.change_request_number }}",
              "changeRequestSysId": "${{ needs.create-change-request.outputs.change_request_sys_id }}"
            }
