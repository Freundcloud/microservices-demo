# ServiceNow Vulnerability Upload Debugging Guide

> Created: 2025-01-28
> Status: Investigating Upload Failures

## Problem Statement

The ServiceNow vulnerability upload process is failing during Step 2 (uploading vulnerabilities) with minimal error information:

```
Step 2: Uploading vulnerabilities...
Error: Process completed with exit code 1.
```

**What we know**:
- ✅ Step 1 succeeds: Configuration Item is found/created
- ✅ Trivy scan completes: 16 vulnerabilities detected
- ❌ Step 2 fails: Upload to `sn_vul_vulnerable_item` table fails
- ❌ No error details shown in logs

## Root Cause Investigation

### Potential Causes

1. **ServiceNow ACL Permissions**
   - User may not have `write` permission on `sn_vul_vulnerable_item` table
   - Check: ServiceNow → System Security → Access Control (ACL)
   - Look for: `sn_vul_vulnerable_item` table ACLs

2. **Invalid JSON Payload**
   - Special characters in vulnerability descriptions breaking JSON
   - Unicode characters not properly escaped
   - Script uses `jq` to build payload, should handle this correctly

3. **Missing Required Fields**
   - ServiceNow table may require fields we're not providing
   - Check: ServiceNow → Tables & Columns → `sn_vul_vulnerable_item`
   - Look for: mandatory fields (marked with red asterisk)

4. **ServiceNow API Rate Limiting**
   - Too many API requests in short time
   - Script makes 2 requests per vulnerability (search + create)
   - 16 vulnerabilities = 32 API calls

5. **Table Configuration**
   - Vulnerable Items table may be locked or read-only
   - Business rules may be blocking inserts
   - Workflow rules may be rejecting data

## Debugging Enhancements Added

### Script Improvements

**Enhanced Error Output** ([scripts/upload-vulnerabilities-to-servicenow.sh](../scripts/upload-vulnerabilities-to-servicenow.sh)):

```bash
# Now shows on error:
- Full API response from ServiceNow (formatted JSON)
- Error message and details from API response
- Exact payload that was sent to ServiceNow
- Fails fast on first error (in DEBUG mode)
```

**Before** (limited output):
```
✗ CVE-2024-1234 - Failed to create vulnerable item
  Error: Unknown error
```

**After** (detailed output):
```
✗ CVE-2024-1234 - Failed to create vulnerable item

Full API Response:
{
  "error": {
    "message": "ACL restriction: You do not have write access to sn_vul_vulnerable_item",
    "detail": "User 'github_integration' lacks required role 'sn_vul.vulnerable_item_writer'"
  }
}

Error Details:
  Message: ACL restriction: You do not have write access to sn_vul_vulnerable_item
  Detail: User 'github_integration' lacks required role 'sn_vul.vulnerable_item_writer'

Payload sent:
{
  "cmdb_ci": "92410c7ec3b43e54e1bbf0cb05013177",
  "severity": "3",
  "source": "Trivy",
  "state": "1",
  "short_description": "CVE-2024-1234 - Vulnerability in package 1.2.3",
  "description": "CVE: CVE-2024-1234\nTitle: Buffer overflow...\n\nPackage: package\n..."
}

Failing fast due to DEBUG mode
```

### Workflow Changes

**Enabled DEBUG Mode** ([.github/workflows/build-images.yaml](../.github/workflows/build-images.yaml)):

```yaml
# Before
./scripts/upload-vulnerabilities-to-servicenow.sh \
  "trivy-results-${{ matrix.service }}.json" \
  "${{ env.ECR_REGISTRY }}/${{ matrix.service }}:${{ inputs.environment }}" \
  "${{ inputs.environment }}"

# After
DEBUG=true ./scripts/upload-vulnerabilities-to-servicenow.sh \
  "trivy-results-${{ matrix.service }}.json" \
  "${{ env.ECR_REGISTRY }}/${{ matrix.service }}:${{ inputs.environment }}" \
  "${{ inputs.environment }}"

env:
  DEBUG: 'true'
```

**Benefits**:
- Stops on first error (doesn't try all 16 vulnerabilities)
- Shows complete error details immediately
- Reduces log noise for easier debugging

## Next Steps

### 1. Trigger Workflow to Get Error Details

```bash
# Push a change or manually trigger workflow
gh workflow run "Build and Push Docker Images" \
  --ref main \
  -f environment=dev \
  -f services='["currencyservice"]'

# Monitor logs
gh run watch
```

### 2. Analyze Error Output

Look for error message in the logs:

**If ACL/Permissions Issue**:
```json
{
  "error": {
    "message": "ACL restriction",
    "detail": "User lacks required role"
  }
}
```

**Solution**: Grant ServiceNow user the required role or use different table.

**If Invalid Payload**:
```json
{
  "error": {
    "message": "Invalid field value",
    "detail": "Field 'severity' must be one of: 1,2,3,4,5"
  }
}
```

**Solution**: Adjust payload generation in script.

**If Missing Required Fields**:
```json
{
  "error": {
    "message": "Missing mandatory fields",
    "detail": "Required field 'assignment_group' is empty"
  }
}
```

**Solution**: Add missing fields to payload.

**If Rate Limiting**:
```json
{
  "error": {
    "message": "Rate limit exceeded",
    "detail": "Too many requests"
  }
}
```

**Solution**: Add delays between API calls or batch uploads.

### 3. Apply Fix Based on Error

#### Fix 1: ACL Permissions

**Check Current User Roles**:
```bash
# Query ServiceNow to check user roles
curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sys_user_has_role?sysparm_query=user.user_name=$SERVICENOW_USERNAME&sysparm_fields=role.name" \
  | jq '.result[].["role.name"]'
```

**Required Roles** (may vary):
- `sn_vul.vulnerable_item_writer` - Write to vulnerable items
- `sn_vul.user` - Basic Vulnerability Response access
- `itil` - IT Service Management access

**Grant Role** (ServiceNow Admin):
1. Navigate to User Administration → Users
2. Find the GitHub integration user
3. Click "Edit"
4. Scroll to "Roles" related list
5. Click "Edit"
6. Add required roles
7. Save

#### Fix 2: Use Alternative Table

If permissions can't be granted, use `sn_vul_third_party_entry` instead:

```bash
# Change in upload-vulnerabilities-to-servicenow.sh
# Replace: sn_vul_vulnerable_item
# With: sn_vul_third_party_entry
```

#### Fix 3: Adjust Payload Fields

If required fields are missing, add them:

```bash
# In upload-vulnerabilities-to-servicenow.sh, line ~192
VUL_ITEM_PAYLOAD=$(echo "$VUL" | jq \
  --arg ci "$CI_SYS_ID" \
  --arg severity "$SN_SEVERITY" \
  --arg assignment_group "YOUR_GROUP_SYS_ID" \  # Add if required
  '{
    "cmdb_ci": $ci,
    "severity": $severity,
    "assignment_group": $assignment_group,  # Add if required
    ...
  }')
```

#### Fix 4: Add Rate Limiting

Add delays between API calls:

```bash
# In upload-vulnerabilities-to-servicenow.sh, after line 247 (after each upload)
# Add:
sleep 0.5  # 500ms delay between uploads
```

## Verification

After applying fix:

```bash
# 1. Commit and push changes
git add scripts/upload-vulnerabilities-to-servicenow.sh
git commit -m "fix: Address ServiceNow vulnerability upload issue"
git push origin main

# 2. Trigger workflow
gh workflow run "Build and Push Docker Images" \
  --ref main \
  -f environment=dev \
  -f services='["currencyservice"]'

# 3. Monitor for success
gh run watch

# 4. Verify in ServiceNow
# Navigate to: Vulnerability Response → Vulnerable Items
# Filter by: Configuration Item = currencyservice image
# Expected: 16 new vulnerable items
```

## Expected Success Output

```
Step 2: Uploading vulnerabilities...
  ✓ CVE-2024-12345 (HIGH) - package-name
  ✓ CVE-2024-12346 (MEDIUM) - another-package
  ✓ CVE-2024-12347 (LOW) - third-package
  ... (16 total)

================================================
Upload completed
================================================

Summary:
  Total vulnerabilities: 16
  Uploaded: 16
  Skipped (duplicates): 0
  Errors: 0

View in ServiceNow:
  https://instance.service-now.com/sn_vul_vulnerable_item_list.do?sysparm_query=cmdb_ci=92410c7e...
```

## Reference

- **Script**: [scripts/upload-vulnerabilities-to-servicenow.sh](../scripts/upload-vulnerabilities-to-servicenow.sh)
- **Workflow**: [.github/workflows/build-images.yaml](../.github/workflows/build-images.yaml)
- **ServiceNow Tables**:
  - `sn_vul_vulnerable_item` - Vulnerable Items
  - `sn_vul_third_party_entry` - Third-Party Vulnerability Data
  - `cmdb_ci` - Configuration Items
- **ServiceNow API Docs**: https://docs.servicenow.com/bundle/vancouver-api-reference/page/integrate/inbound-rest/concept/c_TableAPI.html

## Related Documentation

- [SERVICENOW-VULNERABILITY-INTEGRATION.md](SERVICENOW-VULNERABILITY-INTEGRATION.md) - Integration overview
- [VULNERABILITY-UPLOAD-FIX-VERIFICATION.md](VULNERABILITY-UPLOAD-FIX-VERIFICATION.md) - Previous fix verification
- [SERVICENOW-INTEGRATION-STATUS.md](SERVICENOW-INTEGRATION-STATUS.md) - Overall integration status
