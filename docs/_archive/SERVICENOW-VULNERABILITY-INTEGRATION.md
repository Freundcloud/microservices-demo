# ServiceNow Vulnerability Response Integration

> **Last Updated**: 2025-01-28
> **Status**: Implemented
> **Purpose**: Upload Trivy container vulnerability scans to ServiceNow Vulnerability Response

## Table of Contents

- [Overview](#overview)
- [Why Custom Integration?](#why-custom-integration)
- [Architecture](#architecture)
- [How It Works](#how-it-works)
- [ServiceNow Data Model](#servicenow-data-model)
- [Implementation Details](#implementation-details)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)
- [Future Enhancements](#future-enhancements)

---

## Overview

This integration automatically uploads container vulnerability scan results from Trivy to ServiceNow Vulnerability Response, enabling centralized vulnerability tracking, compliance reporting, and risk management.

### What Gets Uploaded

- **Container Images**: Docker images scanned during CI/CD pipeline
- **Vulnerabilities**: CVEs found by Trivy in image packages
- **Severity**: Critical, High, Medium, Low vulnerabilities
- **Package Details**: Affected packages, installed versions, fixed versions

### Benefits

✅ **Centralized Tracking**: All vulnerabilities in one place (ServiceNow)
✅ **Compliance**: Audit trail for security compliance
✅ **Risk Management**: Link vulnerabilities to assets (Docker images)
✅ **Change Integration**: Associate vulnerabilities with change requests
✅ **Reporting**: ServiceNow dashboards and reports

---

## Why Custom Integration?

### The Problem

ServiceNow provides a GitHub Action called `servicenow-devops-security-result@v3.0.0`, but it **only supports**:
- Veracode
- Checkmarx One
- Checkmarx SAST

**Our scanners** (Trivy, CodeQL, Semgrep, Gitleaks, Checkov) are **NOT supported**.

### The Solution

We implemented a **custom REST API integration** that:
1. Parses Trivy JSON scan results
2. Transforms data to ServiceNow schema
3. Uploads via ServiceNow Table API
4. Creates proper relationships (CI ← Vulnerability ← Vulnerable Item)

---

## Architecture

### High-Level Flow

```mermaid
graph LR
    A[Build Docker Image] --> B[Trivy Scan JSON]
    B --> C[Parse Results]
    C --> D{Has Vulnerabilities?}
    D -->|No| E[Skip Upload]
    D -->|Yes| F[Transform to ServiceNow Format]
    F --> G[Create/Find CI]
    G --> H[Create/Find Vulnerability Entries]
    H --> I[Create Vulnerable Items]
    I --> J[ServiceNow Vulnerability Response]
```

### Components

| Component | Purpose | Location |
|-----------|---------|----------|
| Trivy Scanner | Scan Docker images for vulnerabilities | `.github/workflows/build-images.yaml` |
| Upload Script | Parse and upload to ServiceNow | `scripts/upload-vulnerabilities-to-servicenow.sh` |
| ServiceNow API | Receive and store vulnerabilities | ServiceNow Vulnerability Response tables |

---

## How It Works

### Step 1: Trivy Scan (JSON Format)

During the build process, Trivy scans each Docker image and outputs JSON:

```yaml
- name: Run Trivy Vulnerability Scanner (JSON for ServiceNow)
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: ${{ env.ECR_REGISTRY }}/frontend:dev-abc123
    format: 'json'
    output: 'trivy-results-frontend.json'
    severity: 'CRITICAL,HIGH,MEDIUM,LOW'
```

**Output Example** (`trivy-results-frontend.json`):
```json
{
  "SchemaVersion": 2,
  "ArtifactName": "533267307120.dkr.ecr.eu-west-2.amazonaws.com/frontend:dev-abc123",
  "Results": [
    {
      "Target": "frontend:dev-abc123 (alpine 3.18.5)",
      "Vulnerabilities": [
        {
          "VulnerabilityID": "CVE-2024-1234",
          "PkgName": "openssl",
          "InstalledVersion": "3.1.0-r1",
          "FixedVersion": "3.1.4-r0",
          "Severity": "HIGH",
          "Title": "OpenSSL vulnerability",
          "Description": "Buffer overflow in OpenSSL..."
        }
      ]
    }
  ]
}
```

### Step 2: Upload to ServiceNow

The upload script is called after Trivy scan completes:

```yaml
- name: Upload Vulnerabilities to ServiceNow
  run: |
    ./scripts/upload-vulnerabilities-to-servicenow.sh \
      "trivy-results-frontend.json" \
      "${{ env.ECR_REGISTRY }}/frontend:dev-abc123" \
      "dev"
  env:
    SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
    SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
    SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
```

### Step 3: Script Processing

The script performs these operations:

#### A. Parse Trivy Results
```bash
TOTAL_VULNS=$(jq '[.Results[]?.Vulnerabilities[]?] | length' "$TRIVY_FILE")
CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$TRIVY_FILE")
```

#### B. Create/Find Configuration Item (CI)

Configuration Items represent assets in ServiceNow CMDB. We create one for each Docker image:

```bash
# Search for existing CI
CI_SEARCH=$(curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/cmdb_ci?sysparm_query=name=$IMAGE_NAME&sysparm_limit=1")

# If not found, create new CI
CI_PAYLOAD=$(jq -n \
  --arg name "$IMAGE_NAME" \
  '{
    "name": $name,
    "short_description": "Docker Image (dev)",
    "category": "Software"
  }')

curl -X POST "$SERVICENOW_INSTANCE_URL/api/now/table/cmdb_ci" -d "$CI_PAYLOAD"
```

**Result**: Docker image tracked as asset in CMDB
- Name: `533267307120.dkr.ecr.eu-west-2.amazonaws.com/frontend:dev-abc123`
- Category: Software
- Type: Configuration Item

#### C. Create Vulnerability Entry

For each unique CVE, create a vulnerability entry:

```bash
VUL_ENTRY_PAYLOAD=$(jq -n \
  --arg cve "$CVE_ID" \
  --arg title "$TITLE" \
  --arg desc "$DESCRIPTION" \
  --arg severity "$SN_SEVERITY" \
  '{
    "vulnerability_id": $cve,
    "short_description": $title,
    "description": $desc,
    "severity": $severity,
    "source": "Trivy"
  }')

curl -X POST "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_entry" -d "$VUL_ENTRY_PAYLOAD"
```

**Result**: CVE definition stored in ServiceNow
- Vulnerability ID: CVE-2024-1234
- Title: OpenSSL vulnerability
- Severity: 2 (High)
- Source: Trivy

#### D. Create Vulnerable Item

Link the CI (Docker image) to the vulnerability:

```bash
VUL_ITEM_PAYLOAD=$(jq -n \
  --arg ci "$CI_SYS_ID" \
  --arg vul "$VUL_ENTRY_SYS_ID" \
  --arg severity "$SN_SEVERITY" \
  '{
    "cmdb_ci": $ci,
    "vulnerability": $vul,
    "severity": $severity,
    "source": "Trivy",
    "state": "open"
  }')

curl -X POST "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_vulnerable_item" -d "$VUL_ITEM_PAYLOAD"
```

**Result**: Relationship created showing which image has which vulnerability

---

## ServiceNow Data Model

### Tables Used

#### 1. cmdb_ci (Configuration Management Database - Configuration Item)

Stores assets (our Docker images).

**Key Fields**:
- `sys_id`: Unique identifier
- `name`: Full Docker image URL
- `short_description`: Human-readable name
- `category`: "Software"
- `asset_tag`: Image name

**Example**:
```json
{
  "sys_id": "a1b2c3d4e5f6...",
  "name": "533267307120.dkr.ecr.eu-west-2.amazonaws.com/frontend:dev-abc123",
  "short_description": "frontend - Docker Image (dev)",
  "category": "Software"
}
```

#### 2. sn_vul_entry (Vulnerability Entry)

Stores CVE definitions.

**Key Fields**:
- `sys_id`: Unique identifier
- `vulnerability_id`: CVE ID (e.g., CVE-2024-1234)
- `short_description`: Vulnerability title
- `description`: Detailed description
- `severity`: 1-5 (1=Critical, 5=Low)
- `source`: "Trivy"

**Example**:
```json
{
  "sys_id": "z9y8x7w6v5u4...",
  "vulnerability_id": "CVE-2024-1234",
  "short_description": "OpenSSL vulnerability",
  "description": "Buffer overflow in OpenSSL...",
  "severity": "2",
  "source": "Trivy"
}
```

#### 3. sn_vul_vulnerable_item (Vulnerable Item)

Links CIs to vulnerabilities (many-to-many relationship).

**Key Fields**:
- `sys_id`: Unique identifier
- `cmdb_ci`: Reference to CI (Docker image)
- `vulnerability`: Reference to vulnerability entry
- `severity`: 1-5
- `state`: "open", "closed", "remediated"
- `source`: "Trivy"
- `short_description`: Summary of affected package
- `description`: Package details

**Example**:
```json
{
  "sys_id": "q1w2e3r4t5y6...",
  "cmdb_ci": "a1b2c3d4e5f6...",
  "vulnerability": "z9y8x7w6v5u4...",
  "severity": "2",
  "state": "open",
  "source": "Trivy",
  "short_description": "Vulnerability in openssl 3.1.0-r1",
  "description": "Package: openssl\nInstalled: 3.1.0-r1\nFixed: 3.1.4-r0"
}
```

### Entity Relationship Diagram

```
┌────────────────────┐
│     cmdb_ci        │
│  (Docker Image)    │
│                    │
│  name: ECR/frontend│
│  category: Software│
└──────────┬─────────┘
           │
           │ 1:N (one image can have many vulnerabilities)
           │
           ▼
┌────────────────────┐         ┌────────────────────┐
│ sn_vul_vulnerable_ │ N:1     │   sn_vul_entry     │
│      item          ├────────>│  (CVE Definition)  │
│ (Relationship)     │         │                    │
│                    │         │  CVE-2024-1234     │
│  cmdb_ci: ref      │         │  Severity: HIGH    │
│  vulnerability: ref│         │  Source: Trivy     │
│  state: open       │         └────────────────────┘
│  source: Trivy     │
└────────────────────┘
```

### Severity Mapping

Trivy uses text severity levels, ServiceNow uses numeric (1-5):

| Trivy Severity | ServiceNow Severity | Numeric Value |
|----------------|---------------------|---------------|
| CRITICAL       | Critical            | 1             |
| HIGH           | High                | 2             |
| MEDIUM         | Medium              | 3             |
| LOW            | Low                 | 4             |
| Other/Unknown  | Informational       | 5             |

**Implementation**:
```bash
case $SEVERITY in
  "CRITICAL") SN_SEVERITY="1" ;;
  "HIGH") SN_SEVERITY="2" ;;
  "MEDIUM") SN_SEVERITY="3" ;;
  "LOW") SN_SEVERITY="4" ;;
  *) SN_SEVERITY="5" ;;
esac
```

---

## Implementation Details

### Files

| File | Purpose | Lines |
|------|---------|-------|
| `scripts/upload-vulnerabilities-to-servicenow.sh` | Main upload script | 320 |
| `.github/workflows/build-images.yaml` | Workflow integration | Modified |
| `scripts/test-servicenow-vulnerability-api.sh` | End-to-end test | 388 |
| `scripts/test-servicenow-vulnerability-quick.sh` | Quick validation | 93 |

### Workflow Integration

**Location**: `.github/workflows/build-images.yaml`

**Trigger**: After Trivy scan completes, before pushing to ECR

**Steps**:
1. Run Trivy scan (JSON output)
2. Upload vulnerabilities to ServiceNow
3. Continue with ECR push and package registration

**Error Handling**:
- Uses `continue-on-error: true`
- Upload failures don't block deployment
- Logs errors for debugging

### Authentication

Uses existing ServiceNow secrets:

```yaml
env:
  SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
  SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
  SERVICENOW_INSTANCE_URL: ${{ secrets.SERVICENOW_INSTANCE_URL }}
```

**Required Permissions**:
- Read/Write access to `cmdb_ci` table
- Read/Write access to `sn_vul_entry` table
- Read/Write access to `sn_vul_vulnerable_item` table

### Duplicate Handling

The script checks for existing records before creating:

```bash
# Check if vulnerable item already exists
VUL_ITEM_SEARCH=$(curl -s \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_vulnerable_item?sysparm_query=cmdb_ci=$CI_SYS_ID^vulnerability=$VUL_ENTRY_SYS_ID&sysparm_limit=1")

if [ "$VUL_ITEM_COUNT" -gt 0 ]; then
  # Skip duplicate
  ((SKIP_COUNT++))
  continue
fi
```

**Benefits**:
- Avoids duplicate vulnerability records
- Idempotent (safe to run multiple times)
- Reduces API calls

### Performance

**Per Service**:
- Parse Trivy JSON: ~1 second
- Create/find CI: ~0.5 seconds
- Process vulnerabilities: ~0.5 seconds per CVE
- **Total**: ~5-10 seconds per service (depends on vulnerability count)

**All 12 Services** (parallel execution):
- Total time: ~10-15 seconds (parallel matrix)

---

## Testing

### Local Testing

We provide three test scripts:

#### 1. Quick Validation (Read-Only)

```bash
./scripts/test-servicenow-vulnerability-quick.sh
```

**Checks**:
- Authentication
- Table access (cmdb_ci, sn_vul_entry, sn_vul_vulnerable_item)
- Shows available fields

#### 2. Full End-to-End Test

```bash
./scripts/test-servicenow-vulnerability-api.sh
```

**Creates**:
- Sample Trivy vulnerability (CVE-2024-1234)
- Test CI (Configuration Item)
- Test vulnerability entry
- Test vulnerable item
- Provides ServiceNow UI link

#### 3. Production Upload Script

```bash
./scripts/upload-vulnerabilities-to-servicenow.sh \
  trivy-results.json \
  "533267307120.dkr.ecr.../frontend:dev-abc123" \
  "dev"
```

**Prerequisites**:
- `.envrc` with ServiceNow credentials
- `jq` installed
- Trivy JSON results file

### Verifying in ServiceNow

After upload, check ServiceNow UI:

1. **Navigate to Vulnerable Items**:
   ```
   https://your-instance.service-now.com/sn_vul_vulnerable_item_list.do
   ```

2. **Filter by CI**:
   - Search for Docker image name
   - View all vulnerabilities for that image

3. **Check Vulnerability Details**:
   - Click on vulnerable item
   - See CVE ID, severity, package details
   - View related vulnerability entry

4. **CMDB Configuration Item**:
   ```
   https://your-instance.service-now.com/cmdb_ci_list.do
   ```
   - Search for Docker image
   - View asset details
   - See all related vulnerabilities

---

## Troubleshooting

### Issue 1: "Table not accessible" (HTTP 403/404)

**Symptom**:
```
✗ sn_vul_vulnerable_item not accessible (HTTP 404)
Note: Vulnerability Response may not be installed
```

**Cause**: ServiceNow Vulnerability Response application not installed

**Solution**:
1. Log in to ServiceNow as admin
2. Navigate to: **System Applications** → **All Available Applications**
3. Search for: "Vulnerability Response"
4. Click **Install**
5. Wait for installation to complete (~10 minutes)

### Issue 2: No vulnerabilities uploaded

**Symptom**: Script completes but no records in ServiceNow

**Debugging**:
```bash
# Check Trivy results
jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json

# Check if vulnerabilities exist
jq '.Results[].Vulnerabilities[] | .VulnerabilityID' trivy-results.json
```

**Common Causes**:
- Trivy scan found no vulnerabilities (good!)
- Trivy JSON file empty or malformed
- All vulnerabilities are duplicates (already uploaded)

### Issue 3: Authentication failures

**Symptom**: HTTP 401 errors

**Solution**:
```bash
# Test credentials
curl -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sys_user?sysparm_limit=1"

# Expected: HTTP 200
```

**Check**:
- Credentials in GitHub Secrets are correct
- User has required permissions
- Password hasn't expired

### Issue 4: Rate limiting

**Symptom**: HTTP 429 errors

**Cause**: Too many API calls to ServiceNow

**Solution**:
- ServiceNow has rate limits (typically 100 requests per minute)
- Our script creates 3 API calls per vulnerability
- For 50 vulnerabilities: 150 API calls
- Add delay if hitting limits:
  ```bash
  sleep 0.1  # 100ms delay between calls
  ```

### Issue 5: jq not found

**Symptom**: `jq: command not found`

**Solution**:
```bash
# GitHub Actions runners have jq pre-installed
# For local testing:
brew install jq  # macOS
apt install jq   # Ubuntu
```

---

## Future Enhancements

### 1. Aggregate Security Scan Upload

**Current**: Only uploads Trivy container scans from build-images.yaml

**Enhancement**: Upload all security scan results from security-scan.yaml:
- CodeQL (SAST)
- Semgrep (SAST)
- Gitleaks (secrets)
- Checkov (IaC)

**Implementation**: Create separate transform functions for each scanner format

### 2. Vulnerability State Management

**Current**: All vulnerabilities marked as "open"

**Enhancement**: Update vulnerability state based on:
- Fixed version deployed → Mark as "remediated"
- Image no longer used → Mark as "closed"
- False positive → Mark as "excluded"

**Implementation**: Add state update logic in script

### 3. Change Request Linking

**Current**: Vulnerabilities tracked separately from changes

**Enhancement**: Link vulnerabilities to change requests:
- Associate with deployment change request
- Block deployments with critical vulnerabilities
- Require approval for high-risk changes

**Implementation**: Add change request reference to vulnerable items

### 4. Automated Remediation Workflow

**Enhancement**: Trigger remediation workflows in ServiceNow:
- Create remediation tasks
- Assign to security team
- Track fix progress
- Verify remediation

### 5. Severity Threshold Enforcement

**Current**: Uploads all severities (Critical, High, Medium, Low)

**Enhancement**: Configurable threshold:
```yaml
with:
  min_severity: HIGH  # Only upload Critical and High
```

**Implementation**: Add filtering in upload script

### 6. Batch API Calls

**Current**: One API call per vulnerability

**Enhancement**: Batch create vulnerable items:
```bash
# Create 100 items in single call
curl -X POST "$URL/api/now/table/sn_vul_vulnerable_item/batch" -d "$BATCH_PAYLOAD"
```

**Benefit**: Reduce API calls by 90%+

### 7. ServiceNow Dashboard

**Enhancement**: Create custom ServiceNow dashboard showing:
- Vulnerabilities by severity
- Vulnerabilities by Docker image
- Trends over time
- Top vulnerable packages

---

## Summary

### What We Built

✅ **Custom REST API integration** to upload Trivy scan results
✅ **Automatic vulnerability tracking** for all Docker images
✅ **ServiceNow Vulnerability Response** integration
✅ **Comprehensive testing** scripts for local validation
✅ **Error handling** and duplicate detection
✅ **CI/CD integration** in build pipeline

### Key Features

| Feature | Status | Details |
|---------|--------|---------|
| Container Scanning | ✅ Working | Trivy scans all 12 Docker images |
| ServiceNow Upload | ✅ Working | Uploads to Vulnerability Response tables |
| CI Creation | ✅ Working | Docker images tracked as CMDB assets |
| Vulnerability Tracking | ✅ Working | CVEs linked to images |
| Duplicate Detection | ✅ Working | Skips existing vulnerabilities |
| Severity Mapping | ✅ Working | Trivy → ServiceNow severity scale |
| Error Handling | ✅ Working | Non-blocking, logs errors |
| Local Testing | ✅ Working | 3 test scripts provided |

### Current Status

**Production Ready**: ✅ Yes

**Requirements**:
- ServiceNow Vulnerability Response application installed
- ServiceNow credentials configured in GitHub Secrets
- `jq` available (pre-installed in GitHub Actions)

**Next Step**: Monitor first production run and verify results in ServiceNow UI

---

## Quick Reference

### Workflow Steps

```yaml
1. Build Docker Image
2. Run Trivy Scan (JSON)
3. Upload to ServiceNow ← NEW
4. Push to ECR
5. Register Package
```

### API Endpoints Used

```
POST /api/now/table/cmdb_ci                  # Create CI
POST /api/now/table/sn_vul_entry             # Create vulnerability
POST /api/now/table/sn_vul_vulnerable_item   # Create vulnerable item
GET  /api/now/table/*?sysparm_query=...      # Search for duplicates
```

### Script Usage

```bash
# Upload script
./scripts/upload-vulnerabilities-to-servicenow.sh \
  <trivy-json> <image-name> <environment>

# Quick test
./scripts/test-servicenow-vulnerability-quick.sh

# Full test
./scripts/test-servicenow-vulnerability-api.sh
```

### ServiceNow UI Links

```
Vulnerable Items:
  https://instance.service-now.com/sn_vul_vulnerable_item_list.do

Vulnerability Entries:
  https://instance.service-now.com/sn_vul_entry_list.do

Configuration Items:
  https://instance.service-now.com/cmdb_ci_list.do
```

---

**Document Version**: 1.0.0
**Last Updated**: 2025-01-28
**Maintained By**: Platform Engineering Team
**Related Docs**:
- [ServiceNow Package Registration](./SERVICENOW-PACKAGE-REGISTRATION-DEEP-DIVE.md)
- [Security Scan Workflow](../.github/workflows/security-scan.yaml)
- [Build Images Workflow](../.github/workflows/build-images.yaml)
