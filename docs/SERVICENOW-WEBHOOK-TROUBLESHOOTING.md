# ServiceNow Webhook and Authentication Troubleshooting

**Created**: 2025-10-21
**Status**: Active Investigation
**Issue**: Webhook check trigger failed + Token authentication failing

## Current Errors

### Error 1: API Authentication Failure
```
{"error":{"message":"User is not authenticated","detail":"Required to provide Auth information"},"status":"failure"}
```

**Test Command Used**:
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${SN_DEVOPS_INTEGRATION_TOKEN}" \
  "https://calitiiltddemo3.service-now.com/api/sn_devops/v3/devops/tool/test?toolId=2fe9c38bc36c72d0e1bbf0cb050131cc"
```

### Error 2: Webhook Check Failed
```
Webhook check trigger failed due to technical issue
For more information, see the error logs in All > DevOps > Administration > Error Logs.
```

## Diagnosis

Both errors suggest the **GitHub tool is not properly configured** in ServiceNow. This is typically caused by:

1. **Integration token not generated** in ServiceNow
2. **GitHub App not properly connected** to ServiceNow DevOps
3. **Webhook URL not configured** correctly
4. **Missing permissions** on the ServiceNow DevOps user/role

## Known Configuration

**From `.envrc` and previous documentation**:
- **Instance URL**: `https://calitiiltddemo3.service-now.com`
- **Tool ID (sys_id)**: `2fe9c38bc36c72d0e1bbf0cb050131cc`
- **Current Token**: `FgZDc9PYn0b5RqGBRoN2K3VddMrHy3pa` (NOT WORKING)

## Step-by-Step Fix

### Step 1: Check ServiceNow Error Logs

1. **Log into ServiceNow**: https://calitiiltddemo3.service-now.com
2. **Navigate to**: `All > DevOps > Administration > Error Logs`
3. **Look for recent errors** related to:
   - GitHub
   - Webhook
   - Authentication
   - Tool ID: `2fe9c38bc36c72d0e1bbf0cb050131cc`

**What to capture**:
- Error message text
- Timestamp
- Any stack traces
- Related sys_ids

### Step 2: Verify GitHub Tool Configuration

#### Method A: Direct Table Access
1. In ServiceNow filter navigator, type: **`sn_devops_orchestration_tool.list`**
2. Find the record with sys_id: `2fe9c38bc36c72d0e1bbf0cb050131cc`
3. Open the record
4. Check the following fields:

**Required Fields**:
- ‚úÖ **Tool Name**: Should be something like "GitHub Demo" or "GitHub"
- ‚úÖ **Tool Type**: Should be "GitHub" or "Orchestration"
- ‚úÖ **Active**: Must be checked/true
- ‚úÖ **URL**: Should be `https://github.com` or `https://api.github.com`
- ‚úÖ **Integration Token**: Should have a value (this is what we need!)

#### Method B: Using Application Navigator
1. In the filter navigator, type: **`DevOps`**
2. Look for: **DevOps > Tools** or **DevOps > Orchestration Tools**
3. Find your GitHub tool
4. Verify configuration

### Step 3: Check GitHub App Integration

ServiceNow DevOps can integrate with GitHub in two ways:

#### Option A: GitHub App (Recommended)
- More secure
- Uses installation-based authentication
- Requires GitHub App to be installed in your GitHub organization

#### Option B: Personal Access Token (Legacy)
- Uses a GitHub Personal Access Token
- Less secure
- Easier to set up for testing

**To check which method you're using**:
1. Open the GitHub tool record in ServiceNow
2. Look for authentication method fields
3. Check if there's a GitHub App installation ID

### Step 4: Generate/Verify Integration Token

The integration token should be **generated by ServiceNow**, not manually created.

**How to find/generate the token**:

1. **Open the GitHub tool record** (sys_id: `2fe9c38bc36c72d0e1bbf0cb050131cc`)
2. **Look for a field like**:
   - "Integration Token"
   - "DevOps Token"
   - "API Token"
   - "Authentication Token"
3. **If the field is empty**:
   - There may be a "Generate Token" button
   - Or you may need to configure GitHub App first
4. **If the field has a value**:
   - Copy the EXACT value (including any special characters)
   - This is the token you need

### Step 5: Verify Webhook Configuration

**Expected Webhook URL Pattern**:
```
https://calitiiltddemo3.service-now.com/api/sn_devops/v1/devops/webhook/github
```

**Check in GitHub**:
1. Go to: https://github.com/Freundcloud/microservices-demo/settings/hooks
2. Look for a webhook pointing to ServiceNow
3. Verify:
   - ‚úÖ URL matches expected pattern
   - ‚úÖ Content type: `application/json`
   - ‚úÖ Events: Check for workflow_job, push, pull_request, etc.
   - ‚úÖ Active: Must be enabled
   - ‚úÖ Recent deliveries: Check for successful deliveries

**Check in ServiceNow**:
1. GitHub tool record should have webhook configuration
2. Verify webhook secret (if used)
3. Check webhook events are enabled

### Step 6: Verify ServiceNow DevOps Plugin

**Required Plugins/Applications**:
- ServiceNow DevOps
- DevOps Change Velocity (if using change management)

**To check**:
1. Navigate to: `System Applications > All Available Applications`
2. Search for: `DevOps`
3. Verify these are installed and active:
   - DevOps
   - DevOps Change Velocity
   - DevOps Integrations

### Step 7: Check User Permissions

The integration user/token needs proper roles:

**Required Roles**:
- `sn_devops.user` - Basic DevOps access
- `sn_devops.integration_user` - For API access
- `sn_devops.orchestration_user` - For orchestration tools

**To verify**:
1. If using a service account, check the user's roles
2. Navigate to: `User Administration > Users`
3. Find the integration user
4. Check assigned roles

## Common Issues & Solutions

### Issue 1: "User is not authenticated"

**Cause**: Token is invalid, expired, or not associated with the tool

**Solutions**:
1. Regenerate the integration token in ServiceNow
2. Verify the token is associated with the correct GitHub tool
3. Check token hasn't been revoked or expired
4. Ensure token is copied completely (no extra spaces)

### Issue 2: "Webhook check trigger failed"

**Cause**: GitHub App or webhook not properly configured

**Solutions**:
1. **Recommended**: Use GitHub App integration instead of PAT
   - More reliable
   - Better error handling
   - Automatic token rotation
2. Verify webhook URL is accessible from GitHub
3. Check ServiceNow firewall rules (if applicable)
4. Verify webhook secret matches (if configured)

### Issue 3: Tool ID Not Found

**Cause**: Tool record doesn't exist or sys_id is wrong

**Solutions**:
1. Search for GitHub tools in `sn_devops_orchestration_tool` table
2. Verify the sys_id: `2fe9c38bc36c72d0e1bbf0cb050131cc`
3. If tool doesn't exist, create a new GitHub tool
4. Update `.envrc` and GitHub secrets with new tool ID

## Recommended Approach: GitHub App Integration

Based on the webhook error, I recommend switching to **GitHub App** integration:

### Benefits:
- ‚úÖ More secure (no long-lived tokens)
- ‚úÖ Better webhook handling
- ‚úÖ Automatic authentication
- ‚úÖ Fine-grained permissions
- ‚úÖ Built-in retry logic

### Setup Steps:

1. **In ServiceNow**:
   - Navigate to: `DevOps > Integrations > GitHub`
   - Follow the GitHub App setup wizard
   - ServiceNow will provide a GitHub App manifest

2. **In GitHub**:
   - Go to: https://github.com/organizations/Freundcloud/settings/apps
   - Create a new GitHub App or use existing ServiceNow app
   - Configure with manifest from ServiceNow
   - Install the app in your organization
   - Select the `microservices-demo` repository

3. **Back in ServiceNow**:
   - Complete the integration by providing the App installation ID
   - Verify the connection
   - ServiceNow will automatically generate the integration token

4. **Update Configuration**:
   - Copy the new integration token from ServiceNow
   - Update `.envrc`:
     ```bash
     export SN_DEVOPS_INTEGRATION_TOKEN='NEW_TOKEN_FROM_SERVICENOW'
     ```
   - Update GitHub secret:
     ```bash
     source .envrc
     gh secret set SN_DEVOPS_INTEGRATION_TOKEN --body "$SN_DEVOPS_INTEGRATION_TOKEN"
     ```

## Testing After Configuration

### Test 1: API Connection
```bash
source .envrc
curl -X POST \
  -H "Content-Type: application/json" \
  "https://calitiiltddemo3.service-now.com/api/sn_devops/v3/devops/tool/test?toolId=2fe9c38bc36c72d0e1bbf0cb050131cc&token=${SN_DEVOPS_INTEGRATION_TOKEN}"
```

**Expected Success Response**:
```json
{
  "status": "success",
  "message": "Tool connection verified"
}
```

### Test 2: GitHub Webhook
1. Go to: https://github.com/Freundcloud/microservices-demo/settings/hooks
2. Find the ServiceNow webhook
3. Click "Recent Deliveries"
4. Click "Redeliver" on a recent payload
5. Verify response code is `200 OK`

### Test 3: Workflow Run
```bash
gh workflow run MASTER-PIPELINE.yaml
```

Monitor for successful:
- Artifact registration
- Change request creation
- Security results registration

## Documentation References

### Previous Related Issues Fixed:
- [SERVICENOW-SECURITY-WEBHOOK-FIX.md](SERVICENOW-SECURITY-WEBHOOK-FIX.md) - Previous webhook configuration fix
- [SERVICENOW-DEVOPS-INTEGRATION-TOKEN-SETUP.md](SERVICENOW-DEVOPS-INTEGRATION-TOKEN-SETUP.md) - Token setup guide

### ServiceNow Official Docs:
- GitHub Actions Integration: Search ServiceNow docs for "GitHub Actions DevOps integration"
- GitHub App Setup: Search for "ServiceNow GitHub App configuration"

## Current Status

**As of 2025-10-21 14:25 UTC**:

‚ùå **Token Authentication**: FAILING
- Token value: `FgZDc9PYn0b5RqGBRoN2K3VddMrHy3pa`
- Error: "User is not authenticated"

‚ùå **Webhook Check**: FAILING
- Error: "Webhook check trigger failed due to technical issue"

üîß **Action Required**:
1. Check ServiceNow Error Logs (All > DevOps > Administration > Error Logs)
2. Verify/regenerate integration token in ServiceNow
3. Consider switching to GitHub App integration (recommended)

## Next Steps

**Immediate**:
1. ‚úÖ Check ServiceNow Error Logs for detailed error messages
2. ‚è≥ Open GitHub tool record (sys_id: `2fe9c38bc36c72d0e1bbf0cb050131cc`)
3. ‚è≥ Verify/generate integration token
4. ‚è≥ Update `.envrc` and GitHub secrets with correct token
5. ‚è≥ Test connection using curl command

**Recommended (for long-term stability)**:
1. Set up GitHub App integration
2. Migrate from token-based to App-based authentication
3. Configure proper webhook retry logic
4. Document the final working configuration

---

**Need Help?**
- ServiceNow Admin: Check error logs and tool configuration
- GitHub Admin: Verify webhook configuration and app installation
- See [SERVICENOW-SECURITY-WEBHOOK-FIX.md](SERVICENOW-SECURITY-WEBHOOK-FIX.md) for related webhook fixes
