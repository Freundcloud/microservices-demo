# ServiceNow Vulnerability Upload Troubleshooting

## Current Issue

The vulnerability upload to ServiceNow is failing with:
```
ACL Exception Insert Failed due to security constraints
```

## User Verification

The `github_integration` user has been confirmed to have:
- ‚úÖ `admin` - System Administrator role
- ‚úÖ `sn_vul.admin` - Full Vulnerability Response admin
- ‚úÖ `sn_vul.vulnerability_admin` - Vulnerability admin
- ‚úÖ `sn_vul.vulnerability_write` - Vulnerability write access
- ‚úÖ `sn_vul.write_all` - Write all vulnerability data
- ‚úÖ 297 total roles assigned

**Despite having admin access, the API still returns ACL exception when trying to create vulnerability entries.**

## Root Cause Analysis

This ACL exception despite having admin roles suggests one of these issues:

### 1. Session Cache (Most Likely)
ServiceNow may be caching the old permissions from before the roles were added.

**Solution:**
1. Log out of ServiceNow completely
2. Clear browser cache
3. Log back in
4. Or impersonate the `github_integration` user in ServiceNow UI
5. Try creating a vulnerability manually to verify permissions

### 2. Scripted ACL
The `sn_vul_entry` table has a scripted ACL that checks conditions beyond role membership.

**Solution:**
1. Navigate to: System Security ‚Üí Access Control (ACL)
2. Filter by: Table = `sn_vul_entry`, Operation = `create`
3. Open the ACL rule
4. Check the "Script" field for custom logic
5. Verify what the script is checking for

Expected ACL script might check:
- Source application scope
- API authentication method
- Required fields in the payload
- Workflow state

### 3. Table Scope/Application Access
The table might be in a different application scope that requires additional permissions.

**Solution:**
1. Navigate to: System Definition ‚Üí Tables
2. Search for: `sn_vul_entry`
3. Check the "Application" field
4. Note the application scope
5. Grant the user access to that application scope if needed

### 4. Wrong Table for API Import
We might be using the wrong table for external vulnerability imports.

**Tables to Check:**
| Table | Purpose |
|-------|---------|
| `sn_vul_entry` | Core vulnerability entries (may require system access) |
| `sn_vul_third_party_entry` | Third-party vulnerability imports (tested, also fails) |
| `sn_vul_vulnerable_item` | Vulnerable items linked to CIs |
| Import Set tables | For bulk imports via Import Sets |

## Recommended Solutions

### Option 1: Use ServiceNow Import Sets (Recommended)
Instead of directly creating vulnerability entries via REST API, use ServiceNow's Import Set framework:

1. **Create Transform Map** in ServiceNow:
   - Navigate to: System Import Sets ‚Üí Create Transform Map
   - Source: Trivy JSON format
   - Target: sn_vul_entry or sn_vul_vulnerable_item
   - Map fields appropriately

2. **Use Import Set REST API**:
   ```bash
   # Upload to staging table
   curl -u "$USER:$PASS" \
     -H "Content-Type: application/json" \
     -X POST \
     "$INSTANCE/api/now/import/u_trivy_import" \
     -d @trivy-results.json

   # Transform automatically applies
   ```

3. **Benefits**:
   - ‚úÖ Better ACL handling
   - ‚úÖ Data validation
   - ‚úÖ Error handling
   - ‚úÖ Audit trail
   - ‚úÖ Bulk import support

### Option 2: Use Vulnerability Response Integration API
ServiceNow Vulnerability Response has a dedicated integration API endpoint.

**Documentation:** Check ServiceNow docs for "Vulnerability Response Integration API"

Typical endpoint structure:
```
POST /api/sn_vul/v1/vulnerability/import
```

### Option 3: Verify Field-Level Security
Some fields in the vulnerability tables may have additional field-level ACLs.

**Steps:**
1. Navigate to: System Security ‚Üí Access Control (ACL)
2. Filter by: Table = `sn_vul_entry`, Type = `field`
3. Check each field for write restrictions
4. Ensure `github_integration` user has write access to all fields we're trying to populate

### Option 4: Check Business Rules
Business rules might be blocking the insert.

**Steps:**
1. Navigate to: System Definition ‚Üí Business Rules
2. Filter by: Table = `sn_vul_entry`
3. Check "Before Insert" rules
4. Look for any validation logic that might reject the insert

## API Testing Commands

### Test 1: Current User Permissions
```bash
source .envrc
curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sys_user?sysparm_query=user_name=$SERVICENOW_USERNAME&sysparm_fields=sys_id,name,user_name" \
  | jq '.'
```

### Test 2: Check Table Accessibility
```bash
# Try to query the table (should work)
curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_entry?sysparm_limit=1" \
  | jq '.'
```

### Test 3: Minimal Insert Test
```bash
# Try with absolute minimal payload
curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  -H "Content-Type: application/json" \
  -X POST \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_entry" \
  -d '{"source":"test"}' \
  | jq '.'
```

### Test 4: Check ACL Debug Mode
```bash
# Enable ACL debugging in ServiceNow UI
# 1. Type "scripts - background" in application navigator
# 2. Run this script:
gs.setProperty('glide.security.acl.debug', 'true');
gs.setProperty('glide.security.acl.debug.table', 'sn_vul_entry');

# 3. Try the API call again
# 4. Check System Logs ‚Üí Security Debug for ACL evaluation details
```

## ServiceNow UI Manual Testing

### Test Vulnerability Creation Manually

1. **Impersonate the User:**
   - Navigate to: User Administration ‚Üí Users
   - Find: `github_integration`
   - Right-click ‚Üí Impersonate User

2. **Try Creating a Vulnerability:**
   - Navigate to: Vulnerability Response ‚Üí Vulnerability
   - Click: New
   - Fill in minimal fields
   - Try to Save

3. **Check Results:**
   - If save succeeds: ACL is working, issue is with API call format
   - If save fails: There's a real permission issue to investigate

## Next Steps

1. ‚úÖ **Confirm roles are applied** (DONE - user has admin + all vul roles)
2. üîÑ **Clear ServiceNow session cache** (log out/in)
3. üîç **Check ACL script conditions** (in ServiceNow UI)
4. üîç **Test manual creation** (impersonate user in UI)
5. üìã **Review alternative import methods** (Import Sets, Integration API)

## Quick Fix: Disable Vulnerability Upload

If we can't resolve the ServiceNow ACL issue quickly, we can:

1. **Skip vulnerability upload** in the workflow:
   ```yaml
   - name: Upload Vulnerabilities to ServiceNow
     continue-on-error: true  # Already set
   ```

2. **Use SonarCloud vulnerabilities** instead:
   - SonarCloud scan already uploads vulnerabilities
   - Available in SonarCloud UI dashboard
   - ServiceNow integration with SonarCloud might work better

3. **Focus on Trivy scan results** in GitHub:
   - Trivy SARIF results uploaded to GitHub Security tab
   - Easier access and better GitHub integration
   - No ServiceNow permission issues

## Summary

**Issue:** ACL exception despite having admin roles
**Most Likely Cause:** Scripted ACL with custom logic or session cache
**Recommended Solution:** Use ServiceNow Import Sets or Vulnerability Integration API
**Alternative:** Skip ServiceNow upload, use SonarCloud + GitHub Security tab instead

---

**Last Updated:** 2025-10-28
**Status:** Investigating ACL restrictions
**User:** github_integration (297 roles including admin)
