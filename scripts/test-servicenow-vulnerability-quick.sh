#!/bin/bash

# Quick ServiceNow Vulnerability API Test
# Purpose: Fast check of ServiceNow Vulnerability Response capabilities

# Load credentials
source .envrc 2>/dev/null || { echo "Error: .envrc not found"; exit 1; }

echo "========================================="
echo "ServiceNow Vulnerability API Quick Test"
echo "========================================="
echo ""

# Test 1: Authentication
echo "TEST 1: Authentication"
RESULT=$(curl -s -o /dev/null -w "%{http_code}" \
  -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sys_user?sysparm_limit=1")
echo "  Result: HTTP $RESULT"
[ "$RESULT" = "200" ] && echo "  ✓ PASS" || echo "  ✗ FAIL"
echo ""

# Test 2: Check sn_vul_vulnerable_item table
echo "TEST 2: Vulnerable Item Table Access"
RESULT=$(curl -s -w "\n%{http_code}" \
  -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_vulnerable_item?sysparm_limit=1")
HTTP_CODE=$(echo "$RESULT" | tail -n1)
BODY=$(echo "$RESULT" | sed '$d')

echo "  Result: HTTP $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
  echo "  ✓ PASS - Table accessible"
  COUNT=$(echo "$BODY" | jq -r '.result | length')
  echo "  Existing records: $COUNT"

  # Show available fields
  if [ "$COUNT" -gt 0 ]; then
    echo ""
    echo "  Available fields:"
    echo "$BODY" | jq -r '.result[0] | keys[]' | sed 's/^/    - /'
  fi
else
  echo "  ✗ FAIL - Table not accessible"
  echo "  Note: Vulnerability Response may not be installed"
  echo ""
  echo "  Error:"
  echo "$BODY" | jq '.' 2>/dev/null | sed 's/^/    /'
fi
echo ""

# Test 3: Check sn_vul_entry table
echo "TEST 3: Vulnerability Entry Table Access"
RESULT=$(curl -s -o /dev/null -w "%{http_code}" \
  -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/sn_vul_entry?sysparm_limit=1")
echo "  Result: HTTP $RESULT"
[ "$RESULT" = "200" ] && echo "  ✓ PASS" || echo "  ✗ FAIL"
echo ""

# Test 4: Check CMDB CI table
echo "TEST 4: CMDB Configuration Item Table Access"
RESULT=$(curl -s -o /dev/null -w "%{http_code}" \
  -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
  "$SERVICENOW_INSTANCE_URL/api/now/table/cmdb_ci?sysparm_limit=1")
echo "  Result: HTTP $RESULT"
[ "$RESULT" = "200" ] && echo "  ✓ PASS" || echo "  ✗ FAIL"
echo ""

echo "========================================="
echo "Quick test complete!"
echo ""
echo "To run full test with sample data:"
echo "  ./scripts/test-servicenow-vulnerability-api.sh"
echo ""
